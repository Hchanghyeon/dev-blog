{"componentChunkName":"component---src-templates-post-jsx","path":"/5/","result":{"data":{"site":{"siteMetadata":{"title":"황창구리의 개발 블로그"}},"markdownRemark":{"id":"07dcf9b9-447a-5c8b-bd96-d5fbcf4d2b4e","excerpt":"공연 예매시 발생하는 좌석 동시성 문제 해결하기 저희 프로젝트는 인터파크와 같은 티켓 예매 사이트로써 많은 사용자가 동시에 사이트에 접근하여 예매하는 경우가 많습니다. 동시에 예매하는 것이 어떠한 문제를 일으키는 것일까요? 1. 문제 이 티켓은 오늘 18시부터 예매할 수 있고 따로 좌석이 없고 스탠딩으로 이루어져 있어 먼저 구매한 순으로 앞자리부터 이용할…","html":"<h1><strong>공연 예매시 발생하는 좌석 동시성 문제 해결하기</strong></h1>\n<p>저희 프로젝트는 인터파크와 같은 티켓 예매 사이트로써 많은 사용자가 동시에 사이트에 접근하여 예매하는 경우가 많습니다. <strong>동시에 예매하는 것이 어떠한 문제를 일으키는 것일까요?</strong></p>\n<h2>1. 문제</h2>\n<div style=\"background-color: #f1f1ef; padding: 10px 20px; color:black; margin-bottom:20px;\">\n<br>\n❗ <b>예를 들어 봅시다.</b><br><br>\n<b>10월 18일 18시에 고척 돔에서 방탄소년단의 공연</b>이 있다고 가정해봅시다.\n<p>이 티켓은 오늘 18시부터 예매할 수 있고 따로 좌석이 없고 스탠딩으로 이루어져 있어 먼저 구매한 순으로 앞자리부터 이용할 수 있다고 합니다. 그럼 오늘 18시에 열리는 사이트는 굉장히 많은 사람이 한꺼번에 몰려서 예매를 시도하겠죠?</p>\n<p>이것을 개발 관점으로 다시 보게 되면 18시에 사용자들이 동시에 예매를 하는 경우 해당하는 공연에 대한 <strong>좌석 수에 동시에 접근하여 좌석 수를 감소시킬 수 있다는 점</strong>입니다. <strong>좌석 수라는 공유된 자원에 여러 명이 접근하여 읽거나 쓰려고 하는 Race Condition</strong>이 발생할 수 있는 것이죠.</p>\n</div>\n<p>위에서 든 예처럼 저희 프로젝트에서는 <strong>Race Condition</strong>이 일어날 수 가능성이 아주 큽니다.</p>\n<p>그럼 성능 테스트 도구를 이용해서 가상으로 1<strong>000명의 사용자가 있다고 생각하고 동시에 예매 API를 호출</strong>해보도록 하겠습니다.</p>\n<p><strong>[1000명의 동시 예매 테스트 전 좌석 수]</strong>\n<span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 660px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/a8d864f58af506a4f6f1f2745902b4fb/7c811/1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 12.352941176470589%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiElEQVR42h2NOw7CMBQEuQxC0EAS2y+OnS+WQwIRX9HB/W8xWBRb7OxIu7JK0XlPUxm8FUQJldFIkdNWllFrTsmp84zW18yx4+g1ZWK+FJwI07xgUt/vtqzUZs3SN4zWcA89rzEQS80gimvKt3Y80tHHWULifZFxC8PfOzeOS+t5xoH3FNN24AcxDkSGTTS78wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='1' title='' src='/dev-blog/static/a8d864f58af506a4f6f1f2745902b4fb/7c811/1.png' srcset='/dev-blog/static/a8d864f58af506a4f6f1f2745902b4fb/e7570/1.png 170w,\n/dev-blog/static/a8d864f58af506a4f6f1f2745902b4fb/f46e7/1.png 340w,\n/dev-blog/static/a8d864f58af506a4f6f1f2745902b4fb/7c811/1.png 660w' sizes='(max-width: 660px) 100vw, 660px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p><strong>[1000명의 동시 예매 테스트 후 좌석 수]</strong>\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 649px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/746b47b4f37c0b5455bbf6bd6ca6bb5a/1bcec/2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 12.352941176470589%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiElEQVR42h2M3QqCQBgFfZnAIi1dd930c9cfTAs16Sp6//eYli6GAwNnIrmmPJ0w2IKxvjE1FfZ8xBvFUlu+leVtCvZSMzZCqxVT8I/w6UpFH/zsHXepUfGBSHRBqy4MJmftHasX9sEjeUIfwh+d80pOLFmKTWIGnbF2jq1t2DphaSVs82euDD9K/EQeN7DGdwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/746b47b4f37c0b5455bbf6bd6ca6bb5a/1bcec/2.png' srcset='/dev-blog/static/746b47b4f37c0b5455bbf6bd6ca6bb5a/e7570/2.png 170w,\n/dev-blog/static/746b47b4f37c0b5455bbf6bd6ca6bb5a/f46e7/2.png 340w,\n/dev-blog/static/746b47b4f37c0b5455bbf6bd6ca6bb5a/1bcec/2.png 649w' sizes='(max-width: 649px) 100vw, 649px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p><strong>[테스트 결과]</strong>\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/fc99b6a6a647f42052eedf391dedb1c1/f77a5/3.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 41.1764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABKUlEQVR42nVQO07FQAzM/RsOwAE4A6IBGjpoEAUFVA9eQPnvJtnvMPYmEQWsZI09tsazrvq+R0wJPiYk4jCOiDFinhfGrFzOGfK890e/6zqYftRe6ZeomqZVwjmnwsZazfcns5seEhMRk/lA8eSC8vSCuzfg/h2oZNO6rOpEhs91jWEYtFZ3G+55cVRQFggXqPh0Sng80aExhkLly3lzkBIXxEUjhJncjKy1IGtywktdcKFLS1xRyQ0DRZbVbU4ih2SJPXDP91AuCL/NMVZv4PyC6uOzxjRZGIb3gVt4Iw4g0Q23Ql1xe5C8YGYP+wxR+3FzaF5fkPsvpPaMPLa/BO2BmouIov0TsX/56qHF5W2Di+tv3DxPHAh0ytsxYlj/RX/gXNDJrT1+AEUDcEqSjF7fAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/fc99b6a6a647f42052eedf391dedb1c1/ca1dc/3.png' srcset='/dev-blog/static/fc99b6a6a647f42052eedf391dedb1c1/e7570/3.png 170w,\n/dev-blog/static/fc99b6a6a647f42052eedf391dedb1c1/f46e7/3.png 340w,\n/dev-blog/static/fc99b6a6a647f42052eedf391dedb1c1/ca1dc/3.png 680w,\n/dev-blog/static/fc99b6a6a647f42052eedf391dedb1c1/02d09/3.png 1020w,\n/dev-blog/static/fc99b6a6a647f42052eedf391dedb1c1/f77a5/3.png 1211w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p>위 리포트에서 <strong>성공한 테스트는 1,000건이라고 나오지만</strong> 실제로 데이터베이스에서 줄어든 좌석 수의 차이를 보게되면 <strong>141,921개에서 141,821개</strong>로 <strong>100개</strong>만 줄어든 것을 확인할 수 있습니다.</p>\n<p>간단하게 말하면 <strong>1,000명의 사용자가 동시에 예매</strong>를 시도했는데 해당 공연의 좌석 수가 <strong>1,000개가 줄어들어야 하는데 100개</strong>만 줄어든 것이죠.</p>\n<h2>2. 왜 이런일이 발생되는 걸까?</h2>\n<p><strong>원인</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/ed313c9a4e23d40a798abc3c4c77f6f2/e3932/4.jpg' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 80.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAQAF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3FBiP//EABYQAQEBAAAAAAAAAAAAAAAAAAARIP/aAAgBAQABBQJcR//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABYQAAMAAAAAAAAAAAAAAAAAABAgMf/aAAgBAQAGPwJIP//EABsQAAIDAAMAAAAAAAAAAAAAAAABESGRMUFx/9oACAEBAAE/IZvrSV8aJuB+GBRP/9oADAMBAAIAAwAAABCwz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAQADAQADAAAAAAAAAAAAAAEAESFBYXGR/9oACAEBAAE/EPWprYsA12odoPtwBu3wQDmnaIAoWf/Z'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/ed313c9a4e23d40a798abc3c4c77f6f2/a22ce/4.jpg' srcset='/dev-blog/static/ed313c9a4e23d40a798abc3c4c77f6f2/0b705/4.jpg 170w,\n/dev-blog/static/ed313c9a4e23d40a798abc3c4c77f6f2/31389/4.jpg 340w,\n/dev-blog/static/ed313c9a4e23d40a798abc3c4c77f6f2/a22ce/4.jpg 680w,\n/dev-blog/static/ed313c9a4e23d40a798abc3c4c77f6f2/29373/4.jpg 1020w,\n/dev-blog/static/ed313c9a4e23d40a798abc3c4c77f6f2/232dc/4.jpg 1360w,\n/dev-blog/static/ed313c9a4e23d40a798abc3c4c77f6f2/e3932/4.jpg 1500w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<ol>\n<li>클라이언트 1과 클라이언트 2에서 동시에 schedule_id가 1인 레코드를 읽습니다.</li>\n<li>두 클라이언트 모두 좌석 수가 595개인 레코드를 읽어왔고 각 클라이언트 객체에서 -1을 적용하여 <strong>594</strong>개로 변경합니다.</li>\n<li>변경 후 schedule_id가 1인 레코드의 좌석 수를 594개로 변경하는 UPDATE 쿼리를 날립니다.</li>\n</ol>\n<p>위 로직을 보면 두 개의 트랜잭션이 하나의 데이터를 동시에 갱신하는 문제를 원인으로 볼 수 있으며 위와 같은 문제를 <strong>갱신 손실이라고 부릅니다.</strong> </p>\n<p>위와 같은 문제를 해결하는 방법으로 여러 가지가 있는데 아래에서 알아보도록 하겠습니다.</p>\n<h2>3. 해결 방법</h2>\n<p>제 생각에 해결할 수 있는 방법은 굉장히 다양하고 많을 것 같습니다. 예를 들어 단일 스레드의 메시지 큐를 활용하여 대기 순서대로 처리하는 방식이 있을 것 같고 DB에 Lock을 걸어서 레코드를 순차적으로 업데이트 시킬 수 있는 방법이 있을 것 같은데 이 글에서는 락을 이용하여 동시성 문제를 해결해보고자 합니다.</p>\n<div style=\"background-color: #f1f1ef; padding: 10px 20px; color:black; margin-bottom:20px;\">\n❗ <b>UPDATE schedule SET seats_count = seats_count -1 WHERE schedule_id = 1</b> 과 같은 방식으로 처리하게되면 **UPDATE시 배타 락이 걸려서 순차적으로 좌석 수를 줄일 수 있습니다만** **비지니스 로직 상에서 발생하는 예외를 처리할 수 없습니다**. 예를 들어 좌석 수가 100개 중 0개가 남았는데 좌석 수를 불러와서 검증하지 않고 바로 업데이트하면 좌석 수가 -1로 업데이트가 될 수 있는 상황이 발생할 수도 있고, 예매 취소시 좌석 수가 증가해야하는데 해당 공연 좌석수의 최대값 보다 큰 값으로 업데이트될 수 있는 문제도 생길 수 있습니다.\n</div>\n<h3>3.1 낙관적 락</h3>\n<p>첫 번째는 낙관적 락입니다.</p>\n<p>낙관적 락은 <strong>충돌이 거의 발생하지 않을 것이라고 가정하고, 충돌이 발생한 경우에 대비하는 방식</strong>입니다. DB에 직접적으로 Lock을 걸지 않고, 충돌(동시성) 문제가 발생하면 그때 처리하는 방식으로도 볼 수 있습니다. 간단하게 말하면 <strong>수정할 때 수정했다고 명시</strong>하여 다른 트랜잭션이 동일한 조건으로 값을 수정할 수 없게 막는 것입니다.</p>\n<p><strong>동작 방식</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/0bd0509cb53f8224d878d98518407916/e3932/5.jpg' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 177.64705882352942%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAkABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe5uyUDYuDQUAD//xAAYEAADAQEAAAAAAAAAAAAAAAAAECERIP/aAAgBAQABBQJVQ16qXj//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AV//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AV//xAAUEAEAAAAAAAAAAAAAAAAAAAAw/9oACAEBAAY/An//xAAeEAACAQQDAQAAAAAAAAAAAAAAAREQIUFRIDFxgf/aAAgBAQABPyGb4L7QrCFoUH2vgkooElEsmeFw/9oADAMBAAIAAwAAABDAAQDzz//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QX//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QX//EAB0QAQEBAQEAAgMAAAAAAAAAAAERACFBUXEQMZH/2gAIAQEAAT8Qs6QDCuF0r9eaXQb2jvW6wiKzjLOObPLn1Ov0uScn8z5qm8tMfL8CHxgJ+t//2Q=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='낙관적 락.jpg' title='' src='/dev-blog/static/0bd0509cb53f8224d878d98518407916/a22ce/5.jpg' srcset='/dev-blog/static/0bd0509cb53f8224d878d98518407916/0b705/5.jpg 170w,\n/dev-blog/static/0bd0509cb53f8224d878d98518407916/31389/5.jpg 340w,\n/dev-blog/static/0bd0509cb53f8224d878d98518407916/a22ce/5.jpg 680w,\n/dev-blog/static/0bd0509cb53f8224d878d98518407916/29373/5.jpg 1020w,\n/dev-blog/static/0bd0509cb53f8224d878d98518407916/232dc/5.jpg 1360w,\n/dev-blog/static/0bd0509cb53f8224d878d98518407916/e3932/5.jpg 1500w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>낙관적 락.jpg</figcaption>\n  </figure></p>\n<ol>\n<li>클라이언트 1과 클라이언트 2가 동시에 schedule_id가 1인 레코드를 읽어옵니다.</li>\n<li>클라이언트 1이 미세하지만, 더 빨리 좌석 수를 -1하고 UPDATE 시키며 테이블에 있는 version 정보를 +1 하고 커밋합니다.</li>\n<li>클라이언트 2도 처음에 읽었던 값을 기반으로 좌석 수를 -1하고 UPDATE를 시도합니다.</li>\n<li>하지만 클라이언트 2가 UPDATE를 시도할 때 이미 클라이언트 1이 UPDATE를 하면서 version 정보를 +1 했기 때문에 UPDATE에 실패하게 되고 예외를 발생시킵니다.</li>\n<li>예외가 발생하면 해당 서비스를 호출한 퍼사드 클래스에서 다시 조회 후 업데이트 로직을 반복시킵니다. </li>\n</ol>\n<p>구현 <strong>코드</strong></p>\n<p><strong>ReservationService.java</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ReservationIdResponse</span> <span class=\"token function\">createReservation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ReservationCreateRequest</span> reservationCreateRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Reservation</span> reservation <span class=\"token operator\">=</span> reservationCreateRequest<span class=\"token punctuation\">.</span><span class=\"token function\">toEntity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">decreaseSeatsCount</span><span class=\"token punctuation\">(</span>reservation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Long</span> reservationId <span class=\"token operator\">=</span> reservationRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>reservation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ReservationIdResponse</span><span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>reservationId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">decreaseSeatsCount</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Reservation</span> reservation<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Schedule</span> schedule <span class=\"token operator\">=</span> scheduleService<span class=\"token punctuation\">.</span><span class=\"token function\">findByScheduleId</span><span class=\"token punctuation\">(</span>reservation<span class=\"token punctuation\">.</span><span class=\"token function\">getScheduleId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    schedule<span class=\"token punctuation\">.</span><span class=\"token function\">decreaseSeatsCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> count <span class=\"token operator\">=</span> scheduleService<span class=\"token punctuation\">.</span><span class=\"token function\">updateSeatsCountById</span><span class=\"token punctuation\">(</span>schedule<span class=\"token punctuation\">.</span><span class=\"token function\">getScheduleId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> schedule<span class=\"token punctuation\">.</span><span class=\"token function\">getSeatsCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        schedule<span class=\"token punctuation\">.</span><span class=\"token function\">getVersion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 좌석 수 업데이트를 실패할 경우 예외를 발생 시킴</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>count <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CommonException</span><span class=\"token punctuation\">(</span><span class=\"token constant\">COMMON_LOCK_ACQUISITION_FAILED</span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>ReservationOptimisticFacade.java</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ReservationOptimisticFacade</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ReservationService</span> reservationService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ReservationIdResponse</span> <span class=\"token function\">createReservation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ReservationCreateRequest</span> reservationCreateRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">ReservationIdResponse</span> reservationIdResponse<span class=\"token punctuation\">;</span>\n\n\t\t\t\t<span class=\"token comment\">// 정상적으로 좌석 수를 업데이트할 때까지 반복</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                reservationIdResponse <span class=\"token operator\">=</span> reservationService<span class=\"token punctuation\">.</span><span class=\"token function\">createReservation</span><span class=\"token punctuation\">(</span>reservationCreateRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">CommonException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 좌석 수 업데이트 중 예외가 발생되면 로그를 찍고 다시 메서드 호출</span>\n                log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> reservationIdResponse<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위와 같이 퍼사드 패턴을 이용하는 경우 ReservationService에 있는 createReservtaion 메서드를 모두 묶어야 하기 때문에 createReservation의 메서드에 많은 로직이 생기면 실패할 때마다 그 많은 로직을 매번 수행해야 하는 부담이 생길 수 있다고 생각이 들었습니다. 그래서 <strong>ReservationService 안에서 좌석 수만 감소시키는 로직에만 낙관적 락을 적용해보았으나 MySQL의 Repeatable Read 격리 수준으로 인해 해당 방법으로는 구현할 수 없다는 것으로 판단을 내렸습니다.</strong> 앞서 말씀드린 트러블 슈팅은 아래 트러블 슈팅 1번을 참고 부탁드립니다.</p>\n<h3>3.2 비관적 락</h3>\n<p>비관적 락은 충돌이 발생할 확률이 높다고 가정하여, 실제로 데이터에 액세스 하기 전에 먼저 락을 걸어 충돌을 예방하는 방식입니다. <strong>데이터베이스에 직접 락을 거는 방식</strong>으로 동시성 이슈 해결에는 확실하나 락으로 인한 성능 저하와 데드락(교착 상태)이 발생할 수 있습니다.</p>\n<p><strong>동작 방식</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/b04cddd3788b5d2a22e7102bf5c2932e/e3932/6.jpg' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 132.35294117647058%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAaABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHt3UgDWNqij//EABkQAAIDAQAAAAAAAAAAAAAAABARACAhQf/aAAgBAQABBQLs0sqn/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAFBABAAAAAAAAAAAAAAAAAAAAMP/aAAgBAQAGPwJP/8QAHRABAAICAgMAAAAAAAAAAAAAAQARITEQIEFRof/aAAgBAQABPyG/YgremGGa4NuGBYtQDdfIU8vT/9oADAMBAAIAAwAAABDrwwz/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/EB//xAAYEQACAwAAAAAAAAAAAAAAAAAAARARUf/aAAgBAgEBPxAtbP8A/8QAHRABAQABBQEBAAAAAAAAAAAAAREAECExQYFhof/aAAgBAQABPxC/gYXkyKGTvOjJ7HhydgC84uzbyzAKX0wBW+Fx69jd0YAn6adaf//Z'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/b04cddd3788b5d2a22e7102bf5c2932e/a22ce/6.jpg' srcset='/dev-blog/static/b04cddd3788b5d2a22e7102bf5c2932e/0b705/6.jpg 170w,\n/dev-blog/static/b04cddd3788b5d2a22e7102bf5c2932e/31389/6.jpg 340w,\n/dev-blog/static/b04cddd3788b5d2a22e7102bf5c2932e/a22ce/6.jpg 680w,\n/dev-blog/static/b04cddd3788b5d2a22e7102bf5c2932e/29373/6.jpg 1020w,\n/dev-blog/static/b04cddd3788b5d2a22e7102bf5c2932e/232dc/6.jpg 1360w,\n/dev-blog/static/b04cddd3788b5d2a22e7102bf5c2932e/e3932/6.jpg 1500w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<ol>\n<li>클라이언트 1이 클라이언트 2보다 먼저 <strong>SELECT … FOR UPDATE</strong>로 배타 락을 획득하며 schedule_id가 1인 레코드를 읽어옵니다.(실제로 동시성이라해서 동시에 접근하는 것이 아닙니다!!)</li>\n<li>클라이언트 2는 <strong>SELECT … FOR UPDATE</strong>로 배타 락을 획득하려 했지만 이미 락이 걸려있어 <strong>대기 상태</strong>에 진입하게 됩니다.</li>\n<li>클라이언트 1은 좌석 수를 -1 시키고 UPDATE 시킨 후 COMMIT 하여 락을 반환시킵니다.</li>\n<li>대기하고 있던 클라이언트 2가 다시 <strong>SELECT … FOR UPDATE</strong>로 배타 락을 획득하며 schedule_id가 1인 레코드를 읽어옵니다.</li>\n<li>클라이언트 2는 좌석 수를 -1 시키고 UPDATE 시킨 후 COMMIT 하여 락을 반환시킵니다.</li>\n</ol>\n<p>구현 <strong>코드</strong></p>\n<p><strong>ReservationService.java</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ReservationIdResponse</span> <span class=\"token function\">createReservation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ReservationCreateRequest</span> reservationCreateRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Reservation</span> reservation <span class=\"token operator\">=</span> reservationCreateRequest<span class=\"token punctuation\">.</span><span class=\"token function\">toEntity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">decreaseSeatsCount</span><span class=\"token punctuation\">(</span>reservation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Long</span> reservationId <span class=\"token operator\">=</span> reservationRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>reservation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ReservationIdResponse</span><span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>reservationId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">decreaseSeatsCount</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Reservation</span> reservation<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Schedule</span> schedule <span class=\"token operator\">=</span> scheduleService<span class=\"token punctuation\">.</span>*<span class=\"token operator\">*</span>findByIdWithPessimisticLock<span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>reservation<span class=\"token punctuation\">.</span><span class=\"token function\">getScheduleId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    schedule<span class=\"token punctuation\">.</span><span class=\"token function\">decreaseSeatsCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    scheduleService<span class=\"token punctuation\">.</span><span class=\"token function\">updateSeatsCountById</span><span class=\"token punctuation\">(</span>schedule<span class=\"token punctuation\">.</span><span class=\"token function\">getScheduleId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> schedule<span class=\"token punctuation\">.</span><span class=\"token function\">getSeatsCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>ScheduleMapper.xml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>select</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>findByScheduleIdWithPerssimisticLock<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">resultType</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Schedule<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        SELECT schedule_id,\n               start_datetime,\n               sequence,\n               seats_count,\n               performance_id,\n               created_datetime,\n               updated_datetime\n        FROM schedule\n        WHERE schedule_id = #{scheduleId}\n        FOR UPDATE;\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>select</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>비관적 락은 생각보다 간단합니다. <strong>FOR UPDATE</strong> 특성상 트랜잭션 안에서도 <strong>최신화 된 데이터를 읽어올 수 있기 때문에</strong> 별도로 퍼사드 클래스로 빼지 않아도 되고 단순히 조회 쿼리에 <strong>FOR UPDATE</strong>만 붙이면 락을 적용할 수 있게 됩니다.</p>\n<p><strong>[RealMySQL 5.4.3 Repeatable Read에서]</strong></p>\n<ul>\n<li>Repeatable Read에서는 <strong>PHANTOM READ 현상이 기본적으로 안 일어난다고 하지만, SELECT … FOR UPDATE와 SELECT … FOR SHARE의 경우 해당 현상이 일어날 수 있습니다.</strong></li>\n<li>\n<p><strong>PHANTOM READ</strong>: 다른 트랜잭션에서 수행한 변경 작업에 의해 레코드가 보였다 안보였다 하는 현상</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/552d4c0f851e033787f4e07f7dafc9a4/14077/7.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 20%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAuklEQVR42m1Oyw6CMBDk/78QE14Kpe1KoRTUBAPjtJrowcNmdh67meza9zBtC1EqYeTCccbgsSwIzr01+lEfrcWgNbNd0gdt4IcBtuuwjCMyl5+gqwrX5sxpYKsaUtcwZQVL1EUBd2nJy+StVjDxOOWYj9mbCOR8wcxsJnkOzbDwqSl4xN2zzcqGvlM8VumBV33i0Zu5r2wa2DB6E9uO9O7ELHiPNQSE6YPkz20DjuM7+/6ef9qvt+94AerLLJZdmo8oAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/552d4c0f851e033787f4e07f7dafc9a4/ca1dc/7.png' srcset='/dev-blog/static/552d4c0f851e033787f4e07f7dafc9a4/e7570/7.png 170w,\n/dev-blog/static/552d4c0f851e033787f4e07f7dafc9a4/f46e7/7.png 340w,\n/dev-blog/static/552d4c0f851e033787f4e07f7dafc9a4/ca1dc/7.png 680w,\n/dev-blog/static/552d4c0f851e033787f4e07f7dafc9a4/14077/7.png 923w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n</li>\n</ul>\n<h3>3.3 Redis를 활용한 분산 락(Pub - Sub)</h3>\n<p>분산 락은 분산된 환경에서 많이 사용하는데요. 예를 들어, 단일 DB가 아닌 스케일 아웃 하여 사용할 때 DB로 가는 요청을 Redis를 이용하여 단일 진입점으로 만들고 순차적으로 요청을 처리할 수 있게 만들 수 있습니다. 저는 스케일 아웃을 하지는 못했지만 스케일 아웃을 한다는 가정을 하고 단일 DB에서 Redis를 이용해서 분산 락을 구현해보았습니다.</p>\n<p><strong>동작 방식</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/60b07b38516532d04ea0fd1052853695/e3932/8.jpg' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 177.64705882352942%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAkABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHu2SNKqTWI0itAA//EABgQAAIDAAAAAAAAAAAAAAAAABEgAAEQ/9oACAEBAAEFAtEpwn//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AV//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AV//xAAUEAEAAAAAAAAAAAAAAAAAAAAw/9oACAEBAAY/An//xAAcEAEAAgIDAQAAAAAAAAAAAAABABEQMSFBUXH/2gAIAQEAAT8hHyW+QWtTbqbOCreZe+SD8wDe2FO5UogE/9oADAMBAAIAAwAAABAYwowAD//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QX//EABcRAQADAAAAAAAAAAAAAAAAAAEQESD/2gAIAQIBAT8QWocf/8QAHRABAAMBAAMBAQAAAAAAAAAAAQARITFBYXFRgf/aAAgBAQABPxBFaGKd7LLPixnYZ/ZYT5N7cKZFerhyCwW3fUHegvNIidXyME2g/KIIq0p4KvWoBaHdgjCf/9k='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='분산 락.jpg' title='' src='/dev-blog/static/60b07b38516532d04ea0fd1052853695/a22ce/8.jpg' srcset='/dev-blog/static/60b07b38516532d04ea0fd1052853695/0b705/8.jpg 170w,\n/dev-blog/static/60b07b38516532d04ea0fd1052853695/31389/8.jpg 340w,\n/dev-blog/static/60b07b38516532d04ea0fd1052853695/a22ce/8.jpg 680w,\n/dev-blog/static/60b07b38516532d04ea0fd1052853695/29373/8.jpg 1020w,\n/dev-blog/static/60b07b38516532d04ea0fd1052853695/232dc/8.jpg 1360w,\n/dev-blog/static/60b07b38516532d04ea0fd1052853695/e3932/8.jpg 1500w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>분산 락.jpg</figcaption>\n  </figure></p>\n<ol>\n<li>클라이언트 1에서 Redis에 먼저 스케줄 ID를 기반으로 락 획득을 요청합니다. (schedule_id인 1이 락으로 잡혀있지 않기 때문에 획득합니다)</li>\n<li>클라이언트 2에서도 그 뒤에 바로 Redis에 스케줄 ID를 기반으로 락 획득을 요청합니다.</li>\n<li>클라이언트 1에서 이미 schedule_id인 1로 Lock을 걸어두었기 때문에 설정해둔 값인 10초 동안 대기상태에 진입하게 됩니다.</li>\n<li>이제 클라이언트 1은 락을 획득 했기 때문에 다음 비지니스 로직인 seats_count를 -1하고 업데이트 쿼리를 날린 후 커밋합니다.</li>\n<li>트랜잭션이 종료되면 unlock() 메서드를 통해 락을 해제하고 Redis에서는 구독자(subscriber)에게 unlock이 되었다고 전달합니다.</li>\n<li>구독자(subscriber)는 unlock 되었다는 메시지를 받고 다시 Redis에 lock을 요청하여 락을 획득합니다.</li>\n<li>락을 획득하면 비지니스 로직인 seats_count를 -1하고 업데이트 쿼리를 날려 커밋합니다.</li>\n</ol>\n<p>구현 <strong>코드</strong></p>\n<p><strong>ReservationService.java</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ReservationIdResponse</span> <span class=\"token function\">createReservation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ReservationCreateRequest</span> reservationCreateRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Reservation</span> reservation <span class=\"token operator\">=</span> reservationCreateRequest<span class=\"token punctuation\">.</span><span class=\"token function\">toEntity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">decreaseSeatsCount</span><span class=\"token punctuation\">(</span>reservation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Long</span> reservationId <span class=\"token operator\">=</span> reservationRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>reservation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ReservationIdResponse</span><span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>reservationId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">decreaseSeatsCount</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Reservation</span> reservation<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Schedule</span> schedule <span class=\"token operator\">=</span> scheduleService<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdWithPessimisticLock</span><span class=\"token punctuation\">(</span>reservation<span class=\"token punctuation\">.</span><span class=\"token function\">getScheduleId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    schedule<span class=\"token punctuation\">.</span><span class=\"token function\">decreaseSeatsCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    scheduleService<span class=\"token punctuation\">.</span><span class=\"token function\">updateSeatsCountById</span><span class=\"token punctuation\">(</span>schedule<span class=\"token punctuation\">.</span><span class=\"token function\">getScheduleId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> schedule<span class=\"token punctuation\">.</span><span class=\"token function\">getSeatsCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>ReservationRedissonFacade.java</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ReservationRedissonFacade</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RedissonClient</span> redissonClient<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ReservationService</span> reservationService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">REDISSON_LOCK_PREFIX</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"LOCK:\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ReservationIdResponse</span> <span class=\"token function\">createReservation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ReservationCreateRequest</span> reservationCreateRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">String</span> key <span class=\"token operator\">=</span> <span class=\"token constant\">REDISSON_LOCK_PREFIX</span> <span class=\"token operator\">+</span> reservationCreateRequest<span class=\"token punctuation\">.</span><span class=\"token function\">getScheduleId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">RLock</span> lock <span class=\"token operator\">=</span> redissonClient<span class=\"token punctuation\">.</span><span class=\"token function\">getLock</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">boolean</span> isLocked <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ReservationIdResponse</span> reservationIdResponse <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t<span class=\"token comment\">// Lock 시도(대기 시간(초), Lock 유효시간, 단위 지정)</span>\n            isLocked <span class=\"token operator\">=</span> lock<span class=\"token punctuation\">.</span><span class=\"token function\">tryLock</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SECONDS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isLocked<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CommonException</span><span class=\"token punctuation\">(</span><span class=\"token constant\">COMMON_LOCK_ACQUISITION_FAILED</span><span class=\"token punctuation\">,</span> reservationCreateRequest<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n\t\t\t\t\t\t<span class=\"token comment\">// Lock 획득시 로직 수행</span>\n            reservationIdResponse <span class=\"token operator\">=</span> reservationService<span class=\"token punctuation\">.</span><span class=\"token function\">createReservation</span><span class=\"token punctuation\">(</span>reservationCreateRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IllegalMonitorStateException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Redisson Lock Already UnLock\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> reservationIdResponse<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위와 같이 Redis를 이용하면 Redis라는 서버가 별도로 있기 때문에 DB로 진입하기 전 미리 Redis를 통해 락을 획득하여 처리할 수 있습니다. 그리고 DB뿐만 아니라 애플리케이션 서버가 스케일 아웃되더라도 동일한 Redis를 바라보고 있기 때문에 스케일 아웃에 대비할 수 있습니다. </p>\n<h2>4. Ngrinder를 활용한 락 종류 별 성능 테스트</h2>\n<p>Ngrinder를 활용하여 <strong>동시성 문제 테스트</strong>와 <strong>처리 속도에 대한 성능 테스트</strong>를 해보고자 합니다.</p>\n<p>공통된 테스트 환경으로 로컬에서 SpringBoot 웹서버를 띄우고 외부 네트워크에 있는 DB나 Redis를 연결해서 사용하는 형태로 Ngrinder는 로컬에서 작동시켜 테스트 시 로컬에 있는 웹서버에 요청하게 됩니다.</p>\n<p>사용자의 수는 1000명이며 <strong>1000명의 사용자가 동시에 예매를 진행하여 1000개의 좌석을 감소시킨다에 초점을 맞춘 테스트</strong>입니다.</p>\n<p><strong>공통 테스트 환경</strong></p>\n<ul>\n<li><strong>테스트 PC</strong>: M1 MacBook Pro(CPU 8 Core, RAM 8GB)</li>\n<li><strong>NAS 서버</strong>: Synology Nas(CPU 4 Core, RAM 10GB)</li>\n</ul>\n<h3>4.1 낙관적 락</h3>\n<p><strong>테스트 환경</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/f98ba856b222f310a4a77e6338490938/ce85c/9.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 49.411764705882355%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABbklEQVR42oVSy07DMBDs//8NH8ARgeDUcqggBdQHlZpXkya2E9vJsGOSQEUBR5O17PXM7tiz4/GIKIqwEoS4WgX8N/q+v7g+a5oGu90WZVHgdDqhLEvkeQbnHbz3Z+i67k+yQFgKyc3t3XSAse96eNuhbdszUNy5T6Gqqi4TaqWgixha63DItQ65TrCto5DwvTpGJfn7/R4P91KEE5FByBgDay1mrRHCdIP5fI40TUNlL/ES189XsI2F0ioI0Q6SZlkm6wbLTYLXWIlkJ1X7YAOJZ2TmYIXjIS8JqlLwMm9kPxeS9Xot3uaI41gscYjeczztskBohIgjEDaqQpu+4XA4oJCLoRI/jrFNJyhEjL4xj8JWqpZmUBcJrKm+CFv5qarAYvEYKphuUdAJrHiGukY/dEJbeDETxDd6NxGy1d+eAVedkLlEqhAxErAL2sQ5iSzjMA+E3DBGhyQu/IC0ZpgjkeLjs+FF2aG6EbToA6sFCNHUSMbVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/f98ba856b222f310a4a77e6338490938/ca1dc/9.png' srcset='/dev-blog/static/f98ba856b222f310a4a77e6338490938/e7570/9.png 170w,\n/dev-blog/static/f98ba856b222f310a4a77e6338490938/f46e7/9.png 340w,\n/dev-blog/static/f98ba856b222f310a4a77e6338490938/ca1dc/9.png 680w,\n/dev-blog/static/f98ba856b222f310a4a77e6338490938/02d09/9.png 1020w,\n/dev-blog/static/f98ba856b222f310a4a77e6338490938/9d567/9.png 1360w,\n/dev-blog/static/f98ba856b222f310a4a77e6338490938/ce85c/9.png 1372w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p><strong>테스트 결과</strong></p>\n<p><strong>[Ngrinder 리포트]</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/c504bafe5fe597f84ae20956b94eeb11/5205e/10.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 41.1764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABO0lEQVR42l1Ry07DMBDM53PkI/gBbpxA4sat4g4tqoSKElV52E68XmeYtZMKEWm071nvpBnHCZoUohl5XeGcQ0oJyxIRQkDOGSvz9okIpon97B36AWFypVbrFU3XdWzQQmLDznt44u+3Dxmsz6zEiBzl1vPyAbwegWYcx0JgZEbcti36vi/xjhvh7v/PEYfvjPcLX+ic59bt5I10zdyuM/OhIC5TgdLfkbeaSKi96jg7ozFNIrUJ81LOqefbEiMwPR2OX584n09cGEqsG4qv1UYxnoDm8tPi2o/8GTMTVUfbuGbqSAKzKXJI3BYHQKstvlmL1UMSX7j4gUFksYpdNFNrNAJP322DvsbM2/C6xbf8fvLjYcT98xV3Tx0e3gaekqjLAqWOIjMXCP8orUqJlcuT1c2mpaDmrDfhF+lLcCCEAVR9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='스크린샷 2023-09-24 오전 1.38.09.png' title='' src='/dev-blog/static/c504bafe5fe597f84ae20956b94eeb11/ca1dc/10.png' srcset='/dev-blog/static/c504bafe5fe597f84ae20956b94eeb11/e7570/10.png 170w,\n/dev-blog/static/c504bafe5fe597f84ae20956b94eeb11/f46e7/10.png 340w,\n/dev-blog/static/c504bafe5fe597f84ae20956b94eeb11/ca1dc/10.png 680w,\n/dev-blog/static/c504bafe5fe597f84ae20956b94eeb11/02d09/10.png 1020w,\n/dev-blog/static/c504bafe5fe597f84ae20956b94eeb11/5205e/10.png 1222w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>스크린샷 2023-09-24 오전 1.38.09.png</figcaption>\n  </figure></p>\n<p><strong>[동시성 테스트 전 좌석 수]</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/6deffeb021cfeaf6025497a337cc493d/034aa/11.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 11.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiUlEQVR42g2MSw6CMAAFuYzRaCS02EI/UAoE0JgQDBuNG+9/iLHLl5l5mdeKYA3RKXSpcGlrUeArzXwrmYQgSEFjLY+xoa1kcjQmsSH2hNChTkdintNdzmSuuHL3NYsz7PPAs7UMWrIYzc9b3rXmY2tilQ6U5DWNrH1IjWEbAusY+baevSzYjgf+EaxEEgCrlQYAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/6deffeb021cfeaf6025497a337cc493d/ca1dc/11.png' srcset='/dev-blog/static/6deffeb021cfeaf6025497a337cc493d/e7570/11.png 170w,\n/dev-blog/static/6deffeb021cfeaf6025497a337cc493d/f46e7/11.png 340w,\n/dev-blog/static/6deffeb021cfeaf6025497a337cc493d/ca1dc/11.png 680w,\n/dev-blog/static/6deffeb021cfeaf6025497a337cc493d/034aa/11.png 717w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p><strong>[동시성 테스트 후 좌석 수]</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/8c5c2ecf601dbe69ae7f01801700c819/d65de/12.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 11.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAi0lEQVR42g3N2QqCQABAUb8miFZGZ3EWHZdRiwoygijorf//hJsP9+3AzWpnid7RBIOShlCW6FxQWcugNEMhCULQ1JHLGOm8whuD04q+S3T9SL7d0Bz21PsdWZUfOXnDOVieU+IaA60UDKXkt4zepeaz1OqCthA8xsQ9tUzOMKeGeep51YHvYm7rFX9guUTq3hlSugAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/8c5c2ecf601dbe69ae7f01801700c819/ca1dc/12.png' srcset='/dev-blog/static/8c5c2ecf601dbe69ae7f01801700c819/e7570/12.png 170w,\n/dev-blog/static/8c5c2ecf601dbe69ae7f01801700c819/f46e7/12.png 340w,\n/dev-blog/static/8c5c2ecf601dbe69ae7f01801700c819/ca1dc/12.png 680w,\n/dev-blog/static/8c5c2ecf601dbe69ae7f01801700c819/d65de/12.png 708w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p><strong>[요약]</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/240f7c49ad622e2f94bf2f6c6d79f0c3/0eb09/34.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 100.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAACuklEQVR42p1Ua1PaQBTl//+XTl92WjutD17yFLVaEESFFgSTAJGQZDcLp/femICKfmhmzmQCu2fPuffszWgVIvQ9hMHiddD/Ab9DH/5iHuPZnoC+mSujwoAWPLxA4M9ThIEHxx6jViniYP87jopZZA/3sPDcdA3vUXRghk/lH1S4kI383lzESDZOnHvY1gjuzIF1f/fk4JSQFc6mtiiYTS1aOMR0YuHBnTwh1VqRbV8QRRrACsul2UAEYyJkTKRQKRXwZecD6rUSdj6/R5WsdTstqokvZKw8CAI0GscolYqwLAv8rFYrbD7L5TK2PH+YwJvPxBrD92KSTctLY0ilpsaEpDCSzc9haE1GqwDj0QBXpGg46OPmuo27YV9qxZblACb2fUGibBvYesYYjWLhEJ8+vkOlXMTu1x006hX0brqpZS6249gYje62Wn1hmXO0WpFso6TL/mNUNi2znYRsm921ZR3iunsp6u7HAyL0tmaRu9vv9zAcDuiwYKv12DJFgAkLuQP8/XMrNpO6rQk9qd9lq4lOp03f/tuWI1LJueIIaR1QFwNws/7LckSBPWlUReHF+YlkslzKo9U8j+uZ5jBWqJTCa0+qsH/bRafdRL93TfFpCnH78mKjMTwMFlI/VvFmbJiQ68Z2mYA7zt/qMTJJFhPLqW1jtlsOyUohf4B8dl/sHhVzdPWO8PPHN9SqJZz/asQTh27I2dkp6vWqwLHtF5kUyzwcLIoL3xIeEIyJM5bbE08WO1U4m02FyHVdGQRgskesLZNCni58l3nCMBmPqWTiMNg6E/AdTu6zT1lUkcEi1AKlzbop+dw+ctk9GaDc4TJZZ8uVciG1zN09PT2hcpTROK6hefsXV2MXh60Bds96+D2YiG25KWyJFbmshjYnk2fd4blYZnUcH56NoY7kN19pQiRvbtQ/oP31IdCIHRQAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/240f7c49ad622e2f94bf2f6c6d79f0c3/0eb09/34.png' srcset='/dev-blog/static/240f7c49ad622e2f94bf2f6c6d79f0c3/e7570/34.png 170w,\n/dev-blog/static/240f7c49ad622e2f94bf2f6c6d79f0c3/f46e7/34.png 340w,\n/dev-blog/static/240f7c49ad622e2f94bf2f6c6d79f0c3/0eb09/34.png 500w' sizes='(max-width: 500px) 100vw, 500px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<h3>4.2 비관적 락</h3>\n<p><strong>테스트 환경</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/f850969999683b01b22ff29e5058af3c/00e88/13.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 48.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaElEQVR42oVS21KDQAzl/z/JJx/8AMfaWmHAoUCRtpTLArtcj0lqGTpWzRCyhOTkbBLL9314ngfHceDvdmKTJAHLNE24J7/5Waw4juG5LlRZIk1TnI5HFGWOcRwxDMONsu8/sVzvA+u3rXzMSfT0XY+2bWGMmbVpGmG3o5ucz5mclwUFsNcKRqXIixJaN9C1wXv2gqQJflyv73tUdY3VaoUk3ktxLsSFuRh/W1Nb49O38bre0E8t7J6cB2yiZ6IMasNJWlFVlWhZFtCmw+P2gKbt5zYwKBe0rlSVUqIsHSUMHfsnYRBFEYIgEBuGobDx9mdi21BsjZ4wuq77BlQnFLGLcB9fGArMJO+rMAtmwElZlglTbkVVKbRVJv2bAadxoMkeYNu2OP5aC2ZS0jZwAY69bMIo8fOV+XA/m8BphZDn3EjQWNHRVRWxW05+uQEyFAbUWoveBFGAITaG+jpbirmyZ3vV5R5+AXvlCOqbukL2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/f850969999683b01b22ff29e5058af3c/ca1dc/13.png' srcset='/dev-blog/static/f850969999683b01b22ff29e5058af3c/e7570/13.png 170w,\n/dev-blog/static/f850969999683b01b22ff29e5058af3c/f46e7/13.png 340w,\n/dev-blog/static/f850969999683b01b22ff29e5058af3c/ca1dc/13.png 680w,\n/dev-blog/static/f850969999683b01b22ff29e5058af3c/02d09/13.png 1020w,\n/dev-blog/static/f850969999683b01b22ff29e5058af3c/9d567/13.png 1360w,\n/dev-blog/static/f850969999683b01b22ff29e5058af3c/00e88/13.png 1399w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p><strong>테스트 결과</strong></p>\n<p><strong>[Ngrinder 리포트]</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/8ee35bae13727c333df6c22490358599/5205e/14.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 41.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABNElEQVR42n1Ru04EMQzc/y+o+QV+gAaJgg5BeSUVQjzukMiSTTYPJ8PYuRcSIqc5J+N4MvZO8/wNaYIiDa01LMtiMcaIdV1t33uHrpyz5atUzM4h+gVdf5YfmD62WzSKJV4WFjs3m9iQ+L1ExEQbBVJcIWsyvghw+wQ8vgCT05foRF+pLNjudvDe2/kv6DrF8Zel4/65Y/NOh8vizVnWlpnUFltLkBrpKNL9isJ9rbofsZRALljUczWeJlrGpG5qFc6LIhTVtmrhHGWhqBZxThJ41uLAfGDvgcUDek9zmfdKTZheXt/gZs9h68tigiqApuAsCezR5RDDkTvl9EEKpjCzqA6wZROsexf/AGcYHDsSCl49OFzefeHi5hPXG2/CpSSCX7FmlLxyBOmIA6fxnDdOCn4AoYBw4l17G6QAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='스크린샷 2023-09-24 오전 1.48.47.png' title='' src='/dev-blog/static/8ee35bae13727c333df6c22490358599/ca1dc/14.png' srcset='/dev-blog/static/8ee35bae13727c333df6c22490358599/e7570/14.png 170w,\n/dev-blog/static/8ee35bae13727c333df6c22490358599/f46e7/14.png 340w,\n/dev-blog/static/8ee35bae13727c333df6c22490358599/ca1dc/14.png 680w,\n/dev-blog/static/8ee35bae13727c333df6c22490358599/02d09/14.png 1020w,\n/dev-blog/static/8ee35bae13727c333df6c22490358599/5205e/14.png 1222w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>스크린샷 2023-09-24 오전 1.48.47.png</figcaption>\n  </figure></p>\n<p><strong>[동시성 처리 전 좌석 수]</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 661px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/34b48b2a76ac7c5b534c11139fd9c510/4128c/15.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 12.352941176470589%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiElEQVR42iWNQQ6CMBQFuYoRo4KiVEpLKwUSsRA1egQPwt3Hn7h4q5nJS3S+Z+4CU/CMrWPqBwajcerMM7R8rp7YWN7WCOuIwfHoxZPmLmwwNa8YicLqQ0ZSblP6qsTuNsxeokYzmgudKmjSFUtVsRRHvnmG2q2x4k/eyonmVqt/42pmWTjl/ABfO0OW6+Ej9QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/34b48b2a76ac7c5b534c11139fd9c510/4128c/15.png' srcset='/dev-blog/static/34b48b2a76ac7c5b534c11139fd9c510/e7570/15.png 170w,\n/dev-blog/static/34b48b2a76ac7c5b534c11139fd9c510/f46e7/15.png 340w,\n/dev-blog/static/34b48b2a76ac7c5b534c11139fd9c510/4128c/15.png 661w' sizes='(max-width: 661px) 100vw, 661px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p><strong>[동시성 처리 후 좌석 수]</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 648px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/72b1b9078e4af128d59b7cf11eb47a50/244f0/16.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 13.529411764705882%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAxUlEQVR42h2My07DMBRE8y2wA7GJ7byaOI6J0gCqamho+iAIpUgUxIr/lw5XXYzmztyZibplj60X+HuLymq896IdWZ5TlCU6SYiVRhlDZWueVg9snlvyLKV2DU7QysZ6nCSTENlEY40SxCykWOmYu+srSvH61BCKnCDlTsVYYV9kNKncWuHkb25vqIyma/yFo3kceGkbTrtXvqcDJ9FTWDE8Lvl0lr/GMUvpt/WEvmUt3rwd+Hk/XrIfm8D5bc/XYeR83PEPGYNrdlhR9RkAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/72b1b9078e4af128d59b7cf11eb47a50/244f0/16.png' srcset='/dev-blog/static/72b1b9078e4af128d59b7cf11eb47a50/e7570/16.png 170w,\n/dev-blog/static/72b1b9078e4af128d59b7cf11eb47a50/f46e7/16.png 340w,\n/dev-blog/static/72b1b9078e4af128d59b7cf11eb47a50/244f0/16.png 648w' sizes='(max-width: 648px) 100vw, 648px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p><strong>[요약]</strong></p>\n<span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 504px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/3f0d3b74100e3e4212ef9a3189de9459/7f322/17.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 98.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAAC2klEQVR42n1Ua1faUBDk//+VfvC0tVZLxSIgDxEUxBeIEMCgJEAg7wfT3QUiWtOcs+fek+TOndmd3ZTvu7DtJRzH/G/YNq30n2UuYC4NmKbxzznXtZHyPAe2taCfNyH75dtK4bkWdO0F6V8HSB/9QPYkjbN8FtpkLN/szb+uYyHlEqDjrA/xLbxu98wgDjqk6694fXmGYeiYzzRia8SXxoDMcDadCIP5bCK3ahNVDjgbIA7f49TYFHQh7VerFaIofBdhGCIVRQEq5QL2v+/JenjwDcXCKe5vrwnEjuX4vo96vYZC/hSj0RD8MOjuE0XRmqG5nGNJ4VFSnU3yXZa8YccRhoEAMAs+yPuPIYBc5bE6xGPnHsNBD0r/EQPlSaRvJUuOHIcuXcbMEgFZe6mYw9e9LyL1+PchyqU82vc3cQV5XSwM9Pu9T6W+k8ze4VytOKmBJ3uW/lFyQDncgvHBz0KKEhBI9/EBtYsK1JEibNgO9o4PGZwrqyh9qOozGdhJZhgGPh5IXrlUQO+pnQjoODZarSY6nTYsy0yuMksOfLpxFcrKgIFnx5b5KHl7MFFyGPq4urxAPnciFS4V8zivnOH2poHlYibsJJ9k6E67TT1sJhYmts1A6eLutgn1eSDyGezupimAcWuR5F7vSeyTZJ21sSnBzIArLH3MVd5I3oLtSt5KC4Lgc8nsw7NCFrlsBtXzIsmvopD7I5OlVi2h1ayvveh7uG420GhcolqtQNMmyZK5K5R+VyTzYOCJ8jIeYUoDgweHMCQ3cKdMpzrFVNjsPm+SqZeNuSYDk+1i0JThmM91ySH3uUwbYsgDgqWyJ13XhReEsFwfNoXnrydOijuEK5w5PqLqFlGmNsydZnD0c59SUMJ1ox4DXl3WUatV5X13qKI9niPTGiDdVFDrrVMgknmsT/UJydPi0c5sTXovQ5SLRtOG2bF9mJ1Pkn1i6HiBsLQ8nkYR/gJWQPSIDDZo9AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='17' title='' src='/dev-blog/static/3f0d3b74100e3e4212ef9a3189de9459/7f322/17.png' srcset='/dev-blog/static/3f0d3b74100e3e4212ef9a3189de9459/e7570/17.png 170w,\n/dev-blog/static/3f0d3b74100e3e4212ef9a3189de9459/f46e7/17.png 340w,\n/dev-blog/static/3f0d3b74100e3e4212ef9a3189de9459/7f322/17.png 504w' sizes='(max-width: 504px) 100vw, 504px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n<h3>4.3 Redis를 활용한 분산 락</h3>\n<p><strong>테스트 환경</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/003188d754c559e0b10881eddebae814/7046d/18.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 48.8235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeklEQVR42o1SXW+CQBDk//+dvva1D6ZNKsYaQRrQRg0KwiFwgMD0Zs0ZY5u0lyzH7cfszu46cRwjiiIEvg/P8xAEAVzXhW/ey+VS7qZp8NsZx586pygKLBYLVGWJ8/kskqscRaFAG99d16Hve1wuFwnKsgy73U7+qe+NfhiGKyCNk9c3yUYlHXiPwygAFFZI0LZt5b1eR5i6M8y+FEptdP0FWmvxc/gZ6gTVWaGuazR1i20RYZ5ODCfSuvJitafTCdvtVgJLw+jFj3HwV8jmLnrjo028w8xdmcGdvoszQcKjj+ePJ9SVhjLUqd9sNqaytfSUd5qmBmLAcbPG8TNAb+JYpWMbTjqsgglIt9PXvlBfVZVIkiQIwxBKKWnN/WGcUO5a058kRLDysNvv72f4MNEReZ7LFnAzmEgGYoS2G6AYukZoMLMNtr0bH3aDPoxh8ClX0MUBgwG9AXIQduT/OaySgLeVMRO2KyU9tGthx/6X2PW56cy/fRPrGylnA9pK2KWlAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/003188d754c559e0b10881eddebae814/ca1dc/18.png' srcset='/dev-blog/static/003188d754c559e0b10881eddebae814/e7570/18.png 170w,\n/dev-blog/static/003188d754c559e0b10881eddebae814/f46e7/18.png 340w,\n/dev-blog/static/003188d754c559e0b10881eddebae814/ca1dc/18.png 680w,\n/dev-blog/static/003188d754c559e0b10881eddebae814/02d09/18.png 1020w,\n/dev-blog/static/003188d754c559e0b10881eddebae814/9d567/18.png 1360w,\n/dev-blog/static/003188d754c559e0b10881eddebae814/7046d/18.png 1362w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p><strong>테스트 결과</strong></p>\n<p><strong>[Ngrinder 리포트]</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/d8ba03bd08850f770886cc8cabc8ae95/2ed29/19.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 41.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJ0lEQVR42l1QSU4EMQzM/688gC9w48SROQEnPoAECGZGIt1JZ7VTOE73bC2VXLGry4ux0wQiQiEGc4P3XiIjhIglBK211tC/Ugqcc5qb7AQ/zVob9QHzu9+rIOcskTGJaFnCEK1G29cbpZS0lmIEhaT5rtp9AM8CY62VaYZBNz4cjpjnc+dbqMEWV86C18+GF4HpK+qE68p9isZZ1lvANQoCqoBJ1l95o6icVq5vEj1HGOe8iCpCzGqs9yxyRxFQ7TWv4s5p5Zqr1/Uk/xQZwHx9/+DPzvAuIBeSLqTTgBc1bQKwTHKBke98OfHRSAxTkHtRkWId9xDDYTLQ+Mxvc113WS9yAvPwZnG/s7h7OuLx3UnHipIjahkoud8qnd5bbsR4la814x+ME3DXv6S4CQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/d8ba03bd08850f770886cc8cabc8ae95/ca1dc/19.png' srcset='/dev-blog/static/d8ba03bd08850f770886cc8cabc8ae95/e7570/19.png 170w,\n/dev-blog/static/d8ba03bd08850f770886cc8cabc8ae95/f46e7/19.png 340w,\n/dev-blog/static/d8ba03bd08850f770886cc8cabc8ae95/ca1dc/19.png 680w,\n/dev-blog/static/d8ba03bd08850f770886cc8cabc8ae95/02d09/19.png 1020w,\n/dev-blog/static/d8ba03bd08850f770886cc8cabc8ae95/2ed29/19.png 1214w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p><strong>[동시성 테스트 전 좌석 수]</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 648px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/72b1b9078e4af128d59b7cf11eb47a50/244f0/20.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 13.529411764705882%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAxUlEQVR42h2My07DMBRE8y2wA7GJ7byaOI6J0gCqamho+iAIpUgUxIr/lw5XXYzmztyZibplj60X+HuLymq896IdWZ5TlCU6SYiVRhlDZWueVg9snlvyLKV2DU7QysZ6nCSTENlEY40SxCykWOmYu+srSvH61BCKnCDlTsVYYV9kNKncWuHkb25vqIyma/yFo3kceGkbTrtXvqcDJ9FTWDE8Lvl0lr/GMUvpt/WEvmUt3rwd+Hk/XrIfm8D5bc/XYeR83PEPGYNrdlhR9RkAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/72b1b9078e4af128d59b7cf11eb47a50/244f0/20.png' srcset='/dev-blog/static/72b1b9078e4af128d59b7cf11eb47a50/e7570/20.png 170w,\n/dev-blog/static/72b1b9078e4af128d59b7cf11eb47a50/f46e7/20.png 340w,\n/dev-blog/static/72b1b9078e4af128d59b7cf11eb47a50/244f0/20.png 648w' sizes='(max-width: 648px) 100vw, 648px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p><strong>[동시성 테스트 후 좌석 수]</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 649px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/96c47b505a33b3244f31e4f21b1623f3/1bcec/21.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 13.529411764705882%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAv0lEQVR42h2OS07DQBQEfRcQAwGJgDO25+uZsY3zgQRIIrHIhh33v0DxYFHqXpRaXeUyMmRDnwt16yklE2LEWItxDt201KsVtdbEmPg47jkfJ2zXkHImpUQZJ06Xb1rrqV6HwhwMozOs+57ByMCdYpMTn95xDp6TNRyEdUm8BCt+Jzi24rjnJZP03TQy95Gq1Evcw4JDjuxE/mPuNM294l1d82M7LreKr6dH9OKGVl2x8ebf30rOcuAtBfbJC4FfG7BnoUMY2ZkAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/96c47b505a33b3244f31e4f21b1623f3/1bcec/21.png' srcset='/dev-blog/static/96c47b505a33b3244f31e4f21b1623f3/e7570/21.png 170w,\n/dev-blog/static/96c47b505a33b3244f31e4f21b1623f3/f46e7/21.png 340w,\n/dev-blog/static/96c47b505a33b3244f31e4f21b1623f3/1bcec/21.png 649w' sizes='(max-width: 649px) 100vw, 649px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p><strong>[요약]</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/90907c4d95000aa5afa55fcc369840b6/ad973/22.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 75.88235294117648%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACFklEQVR42oVUiZKaQBTk/z8tqc2xqayCgNyIcg3DrdB5b1R0dTdLVRcDJT39unvU+r5F19UL+r5ZkKYJwsDFYb/Dbhdiv4+efnOPYWihdV2DkRZXdK1EUwt1ty0DP1++YfX2itffL+q5liXapvoA/E0NTYgcW9uA59pwHRNlkaLtJHijqhLIshTzPF8wYZpOn+J0OkIr8hTr1R8i3cDQ35Bne/Q0FstPkhie52LGfEf6MfjiDTVRZjA3awS+Qyqts0Iagb1qmhpSSpyv+QI8PN/eTxMRZqTo14/vsMw1jPVfUpgo/8axQxgGMAydfJOQtSQLKgrqAFGWal3SPc8zFEVB1mT0zQhtGLrz/McBx7GncRtSVoHTF6KkdGPs4ni5m+YGPtkQ+L6yY7sl710Hur5SmyoPLVNHkR8UESfcEnoVSqUU3Dy6H/n5WY0sylwRsnfTacBAfWIPOZS8yBFHoZrgmvIN88O781pjImdrkl+eSnmfRIqQFUpJ/WrbZfevklYKmdC2dFLiY2OsEBHxSL4qhTQuJ32txHOy73FRmKlSR6F/qY4N39+Ssho1mey5LvVxh4lLPU9fK2QPXcdCQmeV1TF4zeVu20alK4T4T/8eFObZQZ0SVsdHj8nDwCEyqTwMfI+6l8I9CKzCDHU3nj39TGElCuqVvSiMo0AFw/8eTdMgjiMUVOC4aOAQaTscF52PF5P+A1+IgJa5cpNwAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/90907c4d95000aa5afa55fcc369840b6/ca1dc/22.png' srcset='/dev-blog/static/90907c4d95000aa5afa55fcc369840b6/e7570/22.png 170w,\n/dev-blog/static/90907c4d95000aa5afa55fcc369840b6/f46e7/22.png 340w,\n/dev-blog/static/90907c4d95000aa5afa55fcc369840b6/ca1dc/22.png 680w,\n/dev-blog/static/90907c4d95000aa5afa55fcc369840b6/ad973/22.png 722w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p><strong>[Request 실패 이유]</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/2e2d805c127debbebedb0589551607a9/c8d22/23.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 18.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA1klEQVR42i1Q226DMBTjPzY6VYwSEgi5h0voqj7u///Hc9AerBPLlm2lUfMCOWmMSkPOBnoQUI8JXT9CKINxshiofT0E2opR4aZmfPJ+dD3a9obvvodUEwYh0Fgf4UKGJ4wLMD4Rke8EaQuUO6HdhhBXuKoZh5x3mMVhYGgnI+5jJhLuIqKpYWk9ENIGHzMizXkr142JRTFR36nvl8e4SF5Qnm8c5xvp/GXpC4M+iO1/YW2mcbGeAeu1uHJNXr9BTssFzXVVC2mFsYHcwzrP8pXhPyjnC3+WH31bzcJwXAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/2e2d805c127debbebedb0589551607a9/ca1dc/23.png' srcset='/dev-blog/static/2e2d805c127debbebedb0589551607a9/e7570/23.png 170w,\n/dev-blog/static/2e2d805c127debbebedb0589551607a9/f46e7/23.png 340w,\n/dev-blog/static/2e2d805c127debbebedb0589551607a9/ca1dc/23.png 680w,\n/dev-blog/static/2e2d805c127debbebedb0589551607a9/02d09/23.png 1020w,\n/dev-blog/static/2e2d805c127debbebedb0589551607a9/c8d22/23.png 1030w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p>Redisson을 이용하면 <strong>Lock 획득을 위한 대기 시간을 얼마나 가질지</strong> 정할 수 있는데, <strong>기본값으로 30초를 설정</strong>하여 30초 이후에는 예외를 발생시켜 예매할 수 없도록 설정해두었기 때문에 <strong>30초 이후부터는 에러</strong>가 발생됩니다.</p>\n<h3>4.4 락 종류 별 비교</h3>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/8f0d3a9990c98a984351693488dabd65/708e8/24.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 44.705882352941174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABYElEQVR42m2S626DMAyFef/n24+tU+lthZRLEhqHEKCcOW67td0sWeIkjnU+myzGHnHwGAJJVqcC+XqFzrYY+U6VX6LPnZa64rhDnq+w267hnEUIDqF36P0ZA99nTa3kwUkd5UFdndDUFeZ5wrJcUNesm19dlgW0bhFjxDSNcv6Y2UkV+Hh/Q1kcpKEnwjxNuEffey6cf3TXWYxjxP+xIOsYJWFaUwvyOI5PJdND8xRt27DrCsYYplLynbI4HnkE7opsTYNpDDwLgrUa3tODIyMu75FwiSkul1mcJuxkIsbhilxXCvtdzrMrBdm5883VIunJSeEdiej8NII/yLqtcNhvJIk6cRdC4AUsUkLcMOl7JN33/fU517xmlra7362x3XyKy4SUNumHiDjNohUvzseb5hkqVYIGRmWN14Za1/LLpC131giyMRrKEFoXxFHSpSVoGkByb/DVOmma4vLQ8BtZwLbYfkWDBwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/8f0d3a9990c98a984351693488dabd65/ca1dc/24.png' srcset='/dev-blog/static/8f0d3a9990c98a984351693488dabd65/e7570/24.png 170w,\n/dev-blog/static/8f0d3a9990c98a984351693488dabd65/f46e7/24.png 340w,\n/dev-blog/static/8f0d3a9990c98a984351693488dabd65/ca1dc/24.png 680w,\n/dev-blog/static/8f0d3a9990c98a984351693488dabd65/02d09/24.png 1020w,\n/dev-blog/static/8f0d3a9990c98a984351693488dabd65/708e8/24.png 1218w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p>사실 위 결과는 네트워크 환경, 서버의 성능 등에 따라 매번 달라지기 때문에 <strong>유의미</strong>하다고 <strong>볼 수는 없을 것 같습니다.</strong> 락을 건다는 것은 어떠한 동시성 문제를 처리하기 위함인데 물론 속도 면에 있어서도 중요하지 않다고 딱 말할 수는 없지만, 그것보다 더 중요한 것은 <strong>어떤 상황에서 어떤 잠금 메커니즘이 가장 적합한지 판단</strong>하는 것이라고 생각합니다. </p>\n<p>예를 들어, 동시 업데이트 충돌 가능성이 낮으면 낙관적 락, 충돌 가능성이 크거나 스케일 아웃이 필요한 경우 비관적 락을 생각해보고, 스케일 아웃, 분산 환경에서 일관된 데이터 접근이 필요한 경우 또는 락 획득에 대한 대기 시간 제한을 걸어 다른 로직을 실행해야 하면 Redis를 활용해볼 수 있을 것 같습니다. </p>\n<p>그리고 위 결과는 <strong>네트워크 환경, 서버의 성능 등 여러 가지를 고려해서 산정해야 하기 때문에 정확한 것은 아니지만</strong> 충돌이 많이 일어날수록 계속 요청을 해야 하는 <strong>낙관적 락이 확실히 더 오래 걸리고, TPS 처리량이 낮은 것</strong>을 볼 수 있습니다. 비관적 락과 Redis 분산 락의 경우 분산 락이 Redis로 처리하여 더 빠를 것으로 예상하였지만 큰 차이를 보이지 못했습니다.</p>\n<h3>4.5 결론</h3>\n<p>위 의견들을 종합하고 경험해보았을 때 저는 현재 프로젝트에서 <strong>비관적 락</strong>이 제일 알맞다고 생각합니다. </p>\n<p>우선 분산된 환경은 아니므로 굳이 Redis를 도입해서 처리해야 할 필요성은 느끼지 못했고 단일 서버일 때 낙관적 락과 비관적 락을 생각해볼 수 있었는데 티켓팅 특성상 한꺼번에 예매를 하기 위해 몰리는 트래픽이 많아 낙관적 락을 사용하면 계속 되는 요청으로 많은 부하가 발생 될 수 있다고 생각이 들었습니다. </p>\n<h2>5. 트러블 슈팅</h2>\n<h3>5.1 트랜잭션 안에 좌석 수를 감소시키는 로직에만 낙관적 락 적용해보기</h3>\n<p><strong>ReservationService.java</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/d21c6863569c49fdc03bfd5e690d5b07/4803b/25.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 48.8235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWUlEQVR42oWSa3KDMAyEOUebQILBxsbGmEcend7/WtuVG5KmM2l/LJJhvPokUaynBWkZ0RqDQ91ifzhSNfbV8Unl7Z3E6qjuccs3FdfzjOvnB6blhHm9IqYZ2ieYeIEeTvDpnN8N44RxWhDiBGN72D5QA/oQKQGyNFQojHFwzsNSxnponpW2MC5kOT/ky7rr0fF8VPpOuulQNw9CpRSWecVKwkCKjpeDiwg2QiubC4ihFBOyjoVF32Qxf/vZdrGvavSk8ENCCAkprhiHJee6c5lMjCSXqFqTDYRq09MM5eFI4YcRLgaaR8gYPGMi+UYkhBLF8Oeifisbat2hJUFjLSqOYFdW90vv+wpvuzJL8ldGT4aq0Zzjwk2fuekL4jgjse0pcLbjGSnw15rWvOncAVt/SZjnoBq0TcMF2Nus2B7VsnXTPeZXs/BfdHdDSXasmFUeXuq/dsXwCwicIGw+WSSjAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='스크린샷 2023-09-17 오후 9.15.47.png' title='' src='/dev-blog/static/d21c6863569c49fdc03bfd5e690d5b07/ca1dc/25.png' srcset='/dev-blog/static/d21c6863569c49fdc03bfd5e690d5b07/e7570/25.png 170w,\n/dev-blog/static/d21c6863569c49fdc03bfd5e690d5b07/f46e7/25.png 340w,\n/dev-blog/static/d21c6863569c49fdc03bfd5e690d5b07/ca1dc/25.png 680w,\n/dev-blog/static/d21c6863569c49fdc03bfd5e690d5b07/4803b/25.png 844w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>스크린샷 2023-09-17 오후 9.15.47.png</figcaption>\n  </figure></p>\n<p>우선 위와 같이 퍼사드 클래스로 바깥쪽에 낙관적 락 로직을 적용하는 것이 아닌 서비스 메서드 트랜잭션안에 적용하는 방법으로 진행해보겠습니다. 이렇게 100명의 클라이언트를 만들어 예매를 시도하면 H2 데이터베이스에서는 잘 됐었지만 <strong>MySQL에서는 첫번째 업데이트만 성공 후 나머지 99명의 요청은 계속 업데이트 실패로 0</strong>이 나오고 있었습니다. 무엇이 문제였을까요?</p>\n<p><strong>REPEATABLE READ로 동작할 때(MySQL)</strong></p>\n<p><strong>동작</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/4ab6d8715270b2e9c3bc8baee87db744/84a58/26.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 31.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABKElEQVR42l2RS3qDMAyEuUUJZB0IGL8tGxLy6Nfe/0jTMdl1oZWk0T+jJq93hFQQZT0qSMawDNDXhOu8IN8eeAWBVgbtNONsPTrj0LmA3kecJoWyWOzbjqA0mu3+PISk3FAoLuuG0Qxwc8HMwfvzGz/sLRT54kIXE06BlTK6XNBqAzEe2+MNw/lG8gbn00FZy6eEQVXCeBAKLz9JqJZKqNBXwlok7CohZyLphTB6JmEVMWw6XvVctCHgMl+gRo+RAoEHdxehuNheJ5y1RV/L2I84YwgUClKgON+sJKiWExcl3xBLwagHmEkw0eK6v/Di0YV2Wor2PnzoCHDY54xoh5XRGbpoVoZeKf8LuilT0BzZ/LJn9SfD+ohqtYuCjjmeKCIkrr+wi8EfrXq7duP67woAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/4ab6d8715270b2e9c3bc8baee87db744/ca1dc/26.png' srcset='/dev-blog/static/4ab6d8715270b2e9c3bc8baee87db744/e7570/26.png 170w,\n/dev-blog/static/4ab6d8715270b2e9c3bc8baee87db744/f46e7/26.png 340w,\n/dev-blog/static/4ab6d8715270b2e9c3bc8baee87db744/ca1dc/26.png 680w,\n/dev-blog/static/4ab6d8715270b2e9c3bc8baee87db744/84a58/26.png 972w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p>동일한 쓰레드에서 schedule을 계속 최신으로 받아서 update시키고 있는데 업데이트 결과가 0으로 나왔습니다.</p>\n<p><strong>결과</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 669px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/b46d3806aefe437f5b972218e7a54434/66b6b/27.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 23.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABNklEQVR42i2QaVeCYBCF+TGdTou5vKAoFMIhN0w2SXAXUhM9hpmdlg/99dtAfbt3Zu55ZoZTBQatzKMlVSEXbiCcn0GtCDB5Bpt6Bl+CSd5gRTTyOVh8Ec0yQ0MSUSctUa0l19CoiaSvwamsgGjgYerYmHsOgocOFJbHRFdhEahdzKNFIP3qAgYBLFZCPPQxtk2MrR4WnouQ8qlOs5wuCthFC6wnI2wXMyxHAVQipwOOVkdPuYUhV3FPW7m6BlNVcFivEAWDbDbNxvMZQv8x85xSyGE1HiL6L0xdC1LuEl67iY4i0SkVaBVG77hG505GUxYz8MSxMOs7WFHmiTbOvOuAG5ldfL8m+Exe8HVI8LbdYNBtY78MM0jo0zv6NoKeQUA/8z/vJxzjZ5x2MWUP+Ej2OG7+/C8tAL6MuG+J2wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/b46d3806aefe437f5b972218e7a54434/66b6b/27.png' srcset='/dev-blog/static/b46d3806aefe437f5b972218e7a54434/e7570/27.png 170w,\n/dev-blog/static/b46d3806aefe437f5b972218e7a54434/f46e7/27.png 340w,\n/dev-blog/static/b46d3806aefe437f5b972218e7a54434/66b6b/27.png 669w' sizes='(max-width: 669px) 100vw, 669px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p>첫번째 사용자의 업데이트만 반영된 이후 <strong>나머지 99명의 업데이트는 반영되지 못했습니다. 이것은 MySQL 격리 수준인 REPEATABLE READ 때문인데요. 아래 그림을 통해 이해하실 수 있습니다.</strong></p>\n<p><strong>REPEATABLE READ 동작 방식</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/bc8b4364fede7c2b9808dfed3eebc244/6ffd1/28.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 177.64705882352942%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAYAAACJ8xqgAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD6UlEQVR42o2W63LaQAyF/br917foA3U6/d0XyKS5Ei4hAQLYJlwC2IANqj6BYJs6pJ5Z1vauzkpHRzJRXixlkiUyz8dSlBvh2u128r8Xe8P90XQxltE8lq2Ust6spd1uy2Aw+BRouy2l2+1Iv9+XzWZzAkzTkWTLzB6KopDJZCqLw7OfvFqtZLFYmKG/Y55MZzLVkWWZLJdLPWQrEYvj8Vjq9bq89Hoye3uTZPxmxpPJxDy+u7uTm5sb6XQ6EsexGed5LtPFWr3s2trz87O8qa0B3t/f28uXlxcZDodmBBj3PT2EzRjyDB19HaORRpYtpVarmX2SJDKbzfaAaZraZl4wPCxC8ME75rIsbeYqdSai6XRqdngdATafz21jrlw5H/AGp2ZYFkpBrjMclkdQaPGE+IERL/DOONSwCPX6+tooiONEx1Bara40GqmGvdB1AE4RAB4m0EKGhzsFSJV0OIIvPAes3e4p2HdpNr/o2lc9/JscMAzMozjKhp/X11cZaiLgg0yxcb1em9bKcqf3AyX9p4L90IN+qZezo4QqAU3tB/IBcvcBJntxPNJMp5rZTMFyO8g5qwQMLyO63GeRrKFDKKnXayohpDM4ZbkqZK/FvVc7BVnJaJZpltdWHWQcFUAFMyoIAT0iHxEb8cQzxn1RbOxkvHVjN+AZSQHEXvY4MHNE2bEQhhzWK8AIFy7xkHVK8fr21pLJQHJdVchSI6rk0AE56OHhwXQJCHx2KEGVVqpdJtfwbf3qShItz7GCR+/7WQjoDYIW9fj4aPdjHRs9qFSPM6WLmo4PkrPSO+chXDWbTctyo9E4NohTTzzJxuv9rywz9oLeJ4J7PKALMfAEztyYJITN1QAxwFXPICAOhDEzwxOC18x4xv1eFcXxXYTWQnFyj9aoacJzjgD37uKHAsZef8cB/3AIoMuIkJCVN1kOwIGwP4bOmA7PAVIlACENtAYgA02iTWhgP0BOxVlANpAMQMkyYLQ1vASQmWdUgAKO35SPAOGn1WrJrVYFXmKEJuHXP1iAXamwoQXwSh06IBx5c/DBc1iaJMvLcvFR6bmMPrq8OXhD8O+LyeYcIMPLj/DgCKN7DfO31nd60Ch13nt6Ml7PhgyH8HdxcWE8kRgaRIIulcdcwyf73hx4fxaQe3QYNoeJelEQqhrn+i1+1fXk0BwqOQyz7O2LkMjmk4YFeFVzOCtsb/N4SPa8rj2TVimHxrB6l5jKkAFFHl4Zrjv482+21zL7wvquBPTWRae+vLy0nghQ5/BHINTpp59RwnVgMkh2mUkKWfZ/Wh5J2A8rAf2/in/kGXhFaVHXeOk1/b7BAvgHKCHWsvZHwH4AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/bc8b4364fede7c2b9808dfed3eebc244/ca1dc/28.png' srcset='/dev-blog/static/bc8b4364fede7c2b9808dfed3eebc244/e7570/28.png 170w,\n/dev-blog/static/bc8b4364fede7c2b9808dfed3eebc244/f46e7/28.png 340w,\n/dev-blog/static/bc8b4364fede7c2b9808dfed3eebc244/ca1dc/28.png 680w,\n/dev-blog/static/bc8b4364fede7c2b9808dfed3eebc244/02d09/28.png 1020w,\n/dev-blog/static/bc8b4364fede7c2b9808dfed3eebc244/9d567/28.png 1360w,\n/dev-blog/static/bc8b4364fede7c2b9808dfed3eebc244/6ffd1/28.png 1500w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<ol>\n<li>REPEATABLE READ는 트랜잭션이 끝나기 전까지는 처음 읽었던 그 값을 유지해서 읽도록 되어있습니다.(다른 트랜잭션에서 수정한 값을 읽는게 아닌 <strong>언두 로그를 읽어서</strong>)</li>\n<li>그래서 첫번째 업데이트 이후 다른 99명의 사용자들도 이미 트랜잭션이 시작된 이후여서 첫번째 업데이트(커밋) 후의 데이터를 읽어오지 않고 언두로그에 있는 데이터를 계속 읽다보니 업데이트를 실패할 수 밖에 없는 것이었습니다.</li>\n</ol>\n<p><strong>READ COMMITTED로 동작할 때(H2, Oracle)</strong></p>\n<ul>\n<li>H2 데이터베이스의 기본 설정 값은 <strong>READ COMMITTED</strong></li>\n</ul>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/63e5da9843117b0a4ce35047487498f6/277d6/29.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 13.529411764705882%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAlUlEQVR42m1Ouw7DIBDL/39Ff6F7t/5AkEoSBpB4hJAEsTCC6nK0S6sOln22T3cDYwzruqLWilLKF//qWp8f/MveGKSUcM5h2zZ477u21vYjNJPvnIUxlN0Rwq1lAVrr3qOOMQZKKaSUMEzTBCFEB+ccy7JgnmfQ58Tkcf5ooPyKcby0ZY19D4gx4jgOnOfZDgXknPECklLepHcB56YAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Advanced' title='' src='/dev-blog/static/63e5da9843117b0a4ce35047487498f6/ca1dc/29.png' srcset='/dev-blog/static/63e5da9843117b0a4ce35047487498f6/e7570/29.png 170w,\n/dev-blog/static/63e5da9843117b0a4ce35047487498f6/f46e7/29.png 340w,\n/dev-blog/static/63e5da9843117b0a4ce35047487498f6/ca1dc/29.png 680w,\n/dev-blog/static/63e5da9843117b0a4ce35047487498f6/277d6/29.png 715w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Advanced</figcaption>\n  </figure></p>\n<ul>\n<li>테스트를 위해 my.cnf 파일을 수정하여 READ-COMMITTED로 변경 후 MYSQL서버 재실행</li>\n</ul>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 278px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/67c9d197571394ad07e7fcf918e63f4f/75062/30.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 30.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABTElEQVR42j1QyU7DUBDLbwDdm0SlF0q3NJTse9K0IZDuHOAAXCrx/xfjPKkcrNF4PCN7pCiKEIYh1us1iqLAaDSC53koy1Lwvu/DNE1UVYU0TTGZTOA4juA1TYOu63BdF1mWYTAYQMrzXAg3m42o7XYbvV4P3W5X1CuuvSzLUBTln+/3+wKqqopeiukiSRJErBad1DWJY8xnM4RBgJSzGrVbl86mdBiQf6Iz0zDg0V3MlPlqhUemk1aMaZP0SW4PB4RcDnjwYTzGYrlEygQmD1nU2HyFwljNTgcdump02rhrtXDbbArcNBqQftIMO8vC1jBxdD0cbAd7y8bZ8/HuhziRKxb80/0Q1bOBE/l6XutW0xkMWSUUWOoAdv3Db03HK0UnRtpxuaIw54G6vnHxGIQC6WwOczjEZ77GB13X89/TGV8vpdBdmO6yP+APetDOeXbCrRoAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='스크린샷 2023-09-17 오후 9.21.41.png' title='' src='/dev-blog/static/67c9d197571394ad07e7fcf918e63f4f/75062/30.png' srcset='/dev-blog/static/67c9d197571394ad07e7fcf918e63f4f/e7570/30.png 170w,\n/dev-blog/static/67c9d197571394ad07e7fcf918e63f4f/75062/30.png 278w' sizes='(max-width: 278px) 100vw, 278px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>스크린샷 2023-09-17 오후 9.21.41.png</figcaption>\n  </figure>    </p>\n<p><strong>동작</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/86757a81060137398c543aa9cded80dd/3ccd1/31.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 33.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABSUlEQVR42nXSy26DMBQE0HxGQySyCq/YgLENNo8QKVJVqcqi+/7/b0zngtJFpS68AMNh5pqDsR5t52D7AD+MyNQFtepQ5BqdHzCECatuca4UTqpG0nb7Mh1OxuFYVlhqg8jnvrIrDp3rYWxPLKIPMzKdodF2A+UjQcDW4nzVSP6ACYMkBAP3m2nBZ0nQ+gBBhzghTusGttoRrDcwxgV3JkkF1A0RS8zuGNsdiUy8tvMNz1IRdMOWsCc4EswFrD3KooFj6mm6YX2BdbtDghJLGOTIUYwEOz73LJRUHjhDz7oj5zXvIBOWTOiGwI8sW+WUL/6XcOS+fYGWg5clYGC9vM5gmFAq+xAJ3nDny6nMbwPdL5b4PWFgAzWv+JDKcsINb0hS5yMuPGV9NcgzBcNKPWvPPMX0dcqN2Vcrp2zxVlR4cP+df8h3VuEHCUbaHoNX1YEAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/86757a81060137398c543aa9cded80dd/ca1dc/31.png' srcset='/dev-blog/static/86757a81060137398c543aa9cded80dd/e7570/31.png 170w,\n/dev-blog/static/86757a81060137398c543aa9cded80dd/f46e7/31.png 340w,\n/dev-blog/static/86757a81060137398c543aa9cded80dd/ca1dc/31.png 680w,\n/dev-blog/static/86757a81060137398c543aa9cded80dd/3ccd1/31.png 967w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p>실패했던 스레드가 다시 요청시 성공하는 것을 볼 수 있습니다.</p>\n<p><strong>결과</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 671px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/0ae181c81783fa068fe550ff3004557f/b5f03/32.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 22.352941176470587%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/klEQVR42h2QW1OCUBRG+TPNNGWopKB5QcSE4ESYIqBiXsLs+v/fVhsf9pw5M/tbs76tjVsGdlMncoYou4/XtRi1mvhGncRq493dEjZ0prUbfL3GzGiQ9B8IZf+p18GXiRz7knfb92jeoMdAAt+HHfs04fxWsAg8HAEWgY8rENVpM7i+ktdEWSZfmzXHPGX7GlOuMj6KNfvlgkyFaNFkzLRr8rkreM8zTuucREBer0seP+OJTfzoMrZaRK4jZvYFcEiXbOczyaSUktklc1IVoClnhCO1/8ojv2L5I1MBXalbiMFErF4ENGzW5SRDAmlU7Zy3mwu0glf/cpWTR4p/icKVaeHSnHoAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/0ae181c81783fa068fe550ff3004557f/b5f03/32.png' srcset='/dev-blog/static/0ae181c81783fa068fe550ff3004557f/e7570/32.png 170w,\n/dev-blog/static/0ae181c81783fa068fe550ff3004557f/f46e7/32.png 340w,\n/dev-blog/static/0ae181c81783fa068fe550ff3004557f/b5f03/32.png 671w' sizes='(max-width: 671px) 100vw, 671px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p>정상적으로 100명이 감소되는 것을 확인해볼 수 있습니다.</p>\n<p><strong>READ COMMITTED 동작 방식</strong></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/62d69a09fd4e3fb8e44ec68f95703170/e3932/33.jpg' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 177.64705882352942%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAkABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAIBAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAH3N2SgbNcygUAD/8QAGBAAAwEBAAAAAAAAAAAAAAAAECAhABH/2gAIAQEAAQUCFaibif/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BX//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BX//EABYQAAMAAAAAAAAAAAAAAAAAACAwMf/aAAgBAQAGPwIIv//EABwQAQACAgMBAAAAAAAAAAAAAAEAESFRECBBYf/aAAgBAQABPyG8+QvZDCUQ+VguowE1wYW8ZXp//9oADAMBAAIAAwAAABDQBQzzz//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QX//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QX//EAB8QAQADAAIBBQAAAAAAAAAAAAEAESExQWEQUXGBkf/aAAgBAQABPxAZpANFsTsV+OpVoJ3UW61LDYK9WLNr9wCB1OSaeLhjUvxFRftLmLt28QAwf31OJ//Z'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/dev-blog/static/62d69a09fd4e3fb8e44ec68f95703170/a22ce/33.jpg' srcset='/dev-blog/static/62d69a09fd4e3fb8e44ec68f95703170/0b705/33.jpg 170w,\n/dev-blog/static/62d69a09fd4e3fb8e44ec68f95703170/31389/33.jpg 340w,\n/dev-blog/static/62d69a09fd4e3fb8e44ec68f95703170/a22ce/33.jpg 680w,\n/dev-blog/static/62d69a09fd4e3fb8e44ec68f95703170/29373/33.jpg 1020w,\n/dev-blog/static/62d69a09fd4e3fb8e44ec68f95703170/232dc/33.jpg 1360w,\n/dev-blog/static/62d69a09fd4e3fb8e44ec68f95703170/e3932/33.jpg 1500w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<p><strong>내 생각</strong></p>\n<p>위와 같은 문제로 REPEATABLE READ 격리 수준에서는 낙관적 락을 적용할 때 트랜잭션 밖에서 퍼사드 클래스를 이용해서 낙관적 락을 적용해야된다고 판단이 내려졌습니다. 하지만 분명 서비스 메서드 안에 로직이 방대해지는 경우 퍼사드 클래스를 이용해서 처리하는 것은 효율적이지 못할 수도 있을 것 같아서 그럴 때는 해당 메서드의 격리수준을 READ COMMITTED로 변경해서 구현해보는 것도 고려해볼 것 같습니다!</p>","frontmatter":{"title":"공연 예매시 발생하는 좌석 동시성 문제 해결하기","date":"September 26, 2023","update":"September 26, 2023","tags":["트러블 슈팅"],"series":null},"fields":{"slug":"/5/","readingTime":{"minutes":24.68}}},"seriesList":{"edges":[{"node":{"id":"08cc27a4-8442-5dfa-984d-00bc49ae7186","fields":{"slug":"/1/"},"frontmatter":{"title":"JOBDA 디챔스 개발자 역량검사와 개발자 구현 능력 검사 후기"}}},{"node":{"id":"d334eaa0-f8b5-54d7-81bc-210915d98625","fields":{"slug":"/2/"},"frontmatter":{"title":"🎉 프로그래머스 백엔드 데브코스 4기 합격 후기"}}},{"node":{"id":"36a5bfb5-13df-5374-a6d5-3d757cc00036","fields":{"slug":"/3/"},"frontmatter":{"title":"📝 프로그래머스 백엔드 데브코스 4기 PRE팀 회고록"}}},{"node":{"id":"19a536f9-90a2-52a7-8eab-976276b09472","fields":{"slug":"/4/"},"frontmatter":{"title":"서버 접속이 안 될 때 해볼 수 있는 tcpdump를 이용한 트러블 슈팅 방법"}}},{"node":{"id":"07dcf9b9-447a-5c8b-bd96-d5fbcf4d2b4e","fields":{"slug":"/5/"},"frontmatter":{"title":"공연 예매시 발생하는 좌석 동시성 문제 해결하기"}}},{"node":{"id":"d0ab993c-e9e5-5382-8f10-e79b5cce9c70","fields":{"slug":"/20's_review/"},"frontmatter":{"title":"개발자가 되기 전 나의 10년 회고록"}}}]},"previous":{"fields":{"slug":"/4/"},"frontmatter":{"title":"서버 접속이 안 될 때 해볼 수 있는 tcpdump를 이용한 트러블 슈팅 방법"}},"next":{"fields":{"slug":"/6/"},"frontmatter":{"title":"소셜 최초 로그인시 회원가입 추가 정보를 받는 로직에 대한 고민"}}},"pageContext":{"id":"07dcf9b9-447a-5c8b-bd96-d5fbcf4d2b4e","series":null,"previousPostId":"19a536f9-90a2-52a7-8eab-976276b09472","nextPostId":"60820b8c-1f49-5d0c-b827-b5963accf653"}},"staticQueryHashes":[],"slicesMap":{}}