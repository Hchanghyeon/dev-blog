{"componentChunkName":"component---src-templates-post-jsx","path":"/oauth_user_register/","result":{"data":{"site":{"siteMetadata":{"title":"황창구리의 개발 블로그"}},"markdownRemark":{"id":"a4edda28-df3f-5aa1-aae4-09846efbeff9","excerpt":"고민 배경 제가 했던 프로젝트에서는 소셜 로그인만 가능하게 두어서 소셜 로그인으로만 회원가입이 가능합니다. 일반 회원가입 로직과는 다르게 OAuth로 최초 로그인시 백엔드 서버에 회원 정보가 없을 때 회원 가입 을 하게 됩니다. OAuth 제공자인 카카오에서 주는 , , ,  로 간편하게 회원가입할 수 있다면 로그인 요청시 바로 회원가입을 진행하면 되지만…","html":"<h2>고민 배경</h2>\n<p>제가 했던 프로젝트에서는 소셜 로그인만 가능하게 두어서 소셜 로그인으로만 회원가입이 가능합니다.</p>\n<p>일반 회원가입 로직과는 다르게 OAuth로 최초 로그인시 백엔드 서버에 회원 정보가 없을 때 <strong>회원 가입</strong> 을 하게 됩니다.</p>\n<p>OAuth 제공자인 카카오에서 주는 <code class=\"language-text\">oauthId</code>, <code class=\"language-text\">email</code>, <code class=\"language-text\">nickname</code>, <code class=\"language-text\">profileImageUrl</code> 로 간편하게 회원가입할 수 있다면 로그인 요청시 바로 회원가입을 진행하면 되지만, 현재 진행하고 있는 프로젝트에서는 회원에 대한 추가적인 정보(<code class=\"language-text\">position</code>, <code class=\"language-text\">address</code>) 를 받아야만 하는 상태입니다.</p>\n<h2>생각해 본 해결 방법</h2>\n<ol>\n<li>우선 OAuth 제공자에서 주는 정보로만 회원가입을 진행하고 정보 미입력 상태를 추가한다. 그리고 추가 입력이 필요한 <code class=\"language-text\">position</code>과 <code class=\"language-text\">address</code>를 이용하는 서비스에 접근할 때 정보 입력 상태를 확인하고 미입력이면 추가 정보를 입력받고 입력 상태면 서비스에 접근을 허용시킨다.</li>\n<li>클라이언트는 소셜 최초 로그인 후 추가 입력을 받는 회원가입 페이지를 접근할 때 짧은 유효기간을 갖는 RegisterToken을 발급받는다.</li>\n</ol>\n<p>우선 떠오르는 방법은 위 두 가지였는데 첫번째 방법이 흔하게 사용되는 것 같았습니다. </p>\n<p>하지만, 추가 입력이 필요한 <code class=\"language-text\">position</code>과 <code class=\"language-text\">address</code>를 이용하는 서비스에 접근할 때 회원 테이블의 정보 상태 컬럼에서 요청한 회원이 정보가 미입력 상태인지 확인해보는 작업이 필요한데 저는 관련된 기능을 요청할 때마다 DB에 접근하여 I/O 작업을 해야한다는 점이 성능상 좋지 못하다고 생각했습니다. CustomAnnotation과 ArgumentResolver로 관련 기능을 구현할 수 있을 것 같지만 성능을 고려하여 두번째 방법을 고려해보기 시작했습니다.</p>\n<p>두번째 해결 방법은 소셜 최초 로그인 후 추가 입력을 받는 회원가입 페이지를 접근할텐데 이때 백엔드 서버에서 짧은 유효기간을 갖는 RegisterToken을 발급받는 것 입니다. 첫번째 방법과는 달리 회원가입 API에서만 검증하면 되기도하며 따로 DB에 접근하지 않고 RegisterToken만 검증하면 된다고 생각해서 더 효율적이라고 생각했습니다.</p>\n<h2>해결</h2>\n<h3><strong>RegisterToken 구현 흐름</strong></h3>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/a2e0ba5c4743b61a4baeaea18dcb14cb/ac7a9/registertoken.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAABYlAAAWJQFJUiTwAAABaElEQVR42oVRXU/CQBDkt/sXfMAnfDHRaAxEiNEQTVRE/AgoFKyhULEUCgKFHr3e97mCGCOIkzTZ2+zszE5jWusgCNrtNqVUCOm/T9AYKa2Gw0G340kpBRfNRtP3RzDpeZ7jOEIIPUMMPs55gAIYQnh8+BC/t8+hKaisu9W0kcgY22+9phQKmiCAMdYLfJKVUoQQWBFGU7NTzFnpvH1s9csonJjdYtW9DcLxfBomwctvMmOMz6C4dkbWXSt7Zu5bvUoYBVppQgmw/iR/t2BL12+9eMWT2k72ebdgn3Z8exqhdcrzFuQkhTTcwqWVavSNnu8my1tw9gT5/5MBUMBz3owInmJUcq6ST/GLeooyOvsjYikwSqCwB7WsuXfdyBCK4X4IVgk9RF6+CflVwBSlZCU5AtOPTi5xs3FQ2oSc2AzLdlbYnu9jgmISvg7MnHXkjmz1paEYZ3KR9grlnzcLKQjHXDCo1it/ADafcf4lHVVSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='image' title='' src='/dev-blog/static/a2e0ba5c4743b61a4baeaea18dcb14cb/ca1dc/registertoken.png' srcset='/dev-blog/static/a2e0ba5c4743b61a4baeaea18dcb14cb/e7570/registertoken.png 170w,\n/dev-blog/static/a2e0ba5c4743b61a4baeaea18dcb14cb/f46e7/registertoken.png 340w,\n/dev-blog/static/a2e0ba5c4743b61a4baeaea18dcb14cb/ca1dc/registertoken.png 680w,\n/dev-blog/static/a2e0ba5c4743b61a4baeaea18dcb14cb/02d09/registertoken.png 1020w,\n/dev-blog/static/a2e0ba5c4743b61a4baeaea18dcb14cb/9d567/registertoken.png 1360w,\n/dev-blog/static/a2e0ba5c4743b61a4baeaea18dcb14cb/ac7a9/registertoken.png 1920w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>image</figcaption>\n  </figure></p>\n<ol>\n<li>최초로 소셜 로그인을 완료하면 OAuth 제공자를 통해 백엔드 서버에서 <code class=\"language-text\">oauthId</code>, <code class=\"language-text\">email</code>, <code class=\"language-text\">nickname</code>, <code class=\"language-text\">profileImageUrl</code>를 받는다.</li>\n<li><code class=\"language-text\">oauthId</code>로 회원 테이블에 사용자가 존재하는지 확인한다.<br>\n(위 그림에서는 이메일로 확인한다고 나와있는데 실제로 OAuth를 이용할 때는 OAuth에서 제공하는 ID로 사용자를 구분해야 함.)\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/dev-blog/static/c46fb754cc0f1478d87578c24da13b39/5b400/kakao.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 20.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApUlEQVR42nWQyQ7EIAxD+///2H2hVRdABUo3ueNIncNIc3jCURJjSKZJwVgN5xxCCDjPE9d14b5vgfofnD2OQ9i2Dd57JC4G+I9RVVVC0zQoy/JbU+d5jizLBPbneRastWLyEmNEwhRMxsG+7zEMA5RSoruuE1iz/9bjOEJrjXVdJdmLGDI6byqKQtJwgctt28qZpinqusayLDJnjMG+7/IdfPIvDz2JMGBX5O6JAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='image' title='' src='/dev-blog/static/c46fb754cc0f1478d87578c24da13b39/ca1dc/kakao.png' srcset='/dev-blog/static/c46fb754cc0f1478d87578c24da13b39/e7570/kakao.png 170w,\n/dev-blog/static/c46fb754cc0f1478d87578c24da13b39/f46e7/kakao.png 340w,\n/dev-blog/static/c46fb754cc0f1478d87578c24da13b39/ca1dc/kakao.png 680w,\n/dev-blog/static/c46fb754cc0f1478d87578c24da13b39/5b400/kakao.png 770w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>image</figcaption>\n  </figure></li>\n<li>회원 테이블에 사용자가 존재하지 않는 경우 RegisterToken이라는 JWT Token을 만든다.</li>\n<li>\n<p>이때 RegisterToken 즉 JWT 토큰에 들어가는 Subject는 OAuth 제공자와 OAuthId 값을 합쳐서 만들며 만료 시간은 10분으로 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">final</span> <span class=\"token class-name\">AuthTokens</span> registerToken <span class=\"token operator\">=</span> jwtProvider<span class=\"token punctuation\">.</span><span class=\"token function\">createRegisterToken</span><span class=\"token punctuation\">(</span>oauthProviderName <span class=\"token operator\">+</span> oauthMember<span class=\"token punctuation\">.</span><span class=\"token function\">getOauthId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n</li>\n<li>OAuth 제공자와 OAuthId를 합치는 이유는 카카오와 네이버의 OAuthId가 동일할 수 있는 것 처럼 OAuth 제공자들의 id의 겹치는 현상을 방지하기 위해</li>\n<li>\n<p>만든 토큰을 클라이언트에게 보내주면서 OAuth를 통해 받은 <code class=\"language-text\">oauthId</code>, <code class=\"language-text\">email</code>, <code class=\"language-text\">nickname</code>, <code class=\"language-text\">profileImageUrl</code>, <code class=\"language-text\">oauthProvider</code>를 같이 넘겨준다.</p>\n<ul>\n<li>같이 넘겨주는 이유는 회원가입시 필요한 정보이기 때문에</li>\n</ul>\n</li>\n<li>클라이언트에서는 회원에게 추가 정보를 입력 받고 회원가입 API 요청을 할 때 헤더에 RegisterToken을 추가하여 보낸다.</li>\n<li>백엔드 서버에서는 해당 요청을 받아 RegisterToken이 정상적인 토큰인지 검증한다.</li>\n<li>\n<p>정상적인 토큰이라면 Controller에서 사용자가 회원가입시 보낸 oauthId와 oauthProvider를 조합하여 토큰에서 나온 subject값이 일치하는지 확인한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@PostMapping</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AuthenticatedMemberResponse</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">createMember</span><span class=\"token punctuation\">(</span>\n        <span class=\"token annotation punctuation\">@SignUp</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> oauthSubject<span class=\"token punctuation\">,</span>\n        <span class=\"token annotation punctuation\">@Valid</span> <span class=\"token annotation punctuation\">@RequestBody</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberCreateRequest</span> memberCreateRequest<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">HttpServletResponse</span> httpServletResponse\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> oauthProviderName <span class=\"token operator\">=</span> memberCreateRequest<span class=\"token punctuation\">.</span><span class=\"token function\">getOauthProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> requestOauthSubject <span class=\"token operator\">=</span> oauthProviderName <span class=\"token operator\">+</span> memberCreateRequest<span class=\"token punctuation\">.</span><span class=\"token function\">getOauthId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>oauthSubject<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>requestOauthSubject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MemberException</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MEMBER_SIGNUP_OAUTH_SUBJECT_INVALID</span><span class=\"token punctuation\">,</span> requestOauthSubject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> 생략\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>위와 같은 검증을 다시 하는 이유는 혹시나 누가 토큰만 탈취했을 때 회원가입 API를 요청을 보내면 토큰만 있어도 회원가입을 할 수 있기 때문(안전 장치)</li>\n</ul>\n</li>\n<li>정상적으로 회원가입을 진행한다.</li>\n</ol>\n<h2>마치며</h2>\n<p>위 로직은 흔하지 않은 방식이겠지만 로그인 과정에서의 효율성과 상황 등 여러가지에 대해 직접 생각해보며 제가 생각한 것을 그대로 구현해내면서 많이 배웠던 것 같습니다.\n아! 그리고 이 글을 작성할 때 이미 두번째 방법으로 구현한 상태인데 첫번째 방법에 대해 글을 작성하다보니 첫번째 방법으로 구현해도 좋을 것 같다고 생각이 들었습니다.\n처음에는 매 요청시마다 무조건 DB에 접근하여 확인해보아야할 것 같다고 생각했었는데 우선 회원가입시키고 로그인시 토큰을 만들 때 회원 정보 입력 상태를 토큰에 같이 넣고 그것을 ArgumentResolver로 처리하면 될 것 같네요. 역시,, 개발은 넓은 시각으로 많이 생각해보아야하는 것 같습니다. 그래도 제 생각을 담아내서 개발한다는 것은 참 즐거운 일인 것 같아요! 😆</p>","frontmatter":{"title":"[OAuth] 소셜 최초 로그인시 회원가입 추가 정보를 받는 로직에 대한 고민","date":"January 12, 2024","update":"January 12, 2024","tags":["OAuth","회원가입"],"series":null},"fields":{"slug":"/oauth_user_register/","readingTime":{"minutes":7.465}}},"seriesList":{"edges":[{"node":{"id":"41b4c21e-5bf0-5a82-bd15-2d62b9974efe","fields":{"slug":"/jobda_decharms/"},"frontmatter":{"title":"JOBDA 디챔스 개발자 역량검사와 개발자 구현 능력 검사 후기"}}},{"node":{"id":"5e7d2747-98d5-5465-b36c-17bedb88d847","fields":{"slug":"/programmers_apply/"},"frontmatter":{"title":"🎉 프로그래머스 백엔드 데브코스 4기 합격 후기"}}},{"node":{"id":"c2d492b3-d781-5a74-b898-2b962a34d975","fields":{"slug":"/programmers_preteam/"},"frontmatter":{"title":"📝 프로그래머스 백엔드 데브코스 4기 PRE팀 회고록"}}},{"node":{"id":"1b7977f1-22ce-5648-9ee1-b1ac301d27f9","fields":{"slug":"/tcpdump/"},"frontmatter":{"title":"서버 접속이 안 될 때 해볼 수 있는 tcpdump를 이용한 트러블 슈팅 방법"}}},{"node":{"id":"82208f17-d589-55b9-8f7f-396eb57f8e2c","fields":{"slug":"/concurrent/"},"frontmatter":{"title":"공연 예매시 발생하는 좌석 동시성 문제 해결하기"}}},{"node":{"id":"a4edda28-df3f-5aa1-aae4-09846efbeff9","fields":{"slug":"/oauth_user_register/"},"frontmatter":{"title":"[OAuth] 소셜 최초 로그인시 회원가입 추가 정보를 받는 로직에 대한 고민"}}}]},"previous":{"fields":{"slug":"/concurrent/"},"frontmatter":{"title":"공연 예매시 발생하는 좌석 동시성 문제 해결하기"}},"next":null},"pageContext":{"id":"a4edda28-df3f-5aa1-aae4-09846efbeff9","series":null,"previousPostId":"82208f17-d589-55b9-8f7f-396eb57f8e2c","nextPostId":null}},"staticQueryHashes":[],"slicesMap":{}}